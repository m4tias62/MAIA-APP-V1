<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MAIA v3.2 - Corrección Comentarios HTML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES DE MAIA --- */
        body { -webkit-tap-highlight-color: transparent; }
        .maia-body { font-family: 'Inter', sans-serif; }
        .main-container { max-width: 1024px; margin: auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; /* Needed for FAB positioning */ }
        .big-button { display: flex; justify-content: center; align-items: center; width: 100%; padding: 2.5rem 1.5rem; border-radius: 1.5rem; font-size: 3rem; font-weight: 700; color: white; text-align: center; line-height: 1.2; transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .big-button:active { transform: scale(0.98); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .simulator-wrapper { background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; width: 100%; flex-grow: 1; padding: 1rem 0;} /* Reduced padding */
        #help-modal.active #help-modal-content { transform: scale(1); opacity: 1; }
        #help-modal-content { transition: opacity 0.3s ease, transform 0.3s ease; transform: scale(0.95); opacity: 0; }
        #listen-button.listening { background-color: #ef4444; }
        #listen-button:disabled { background-color: #9ca3af; cursor: not-allowed;}
        /* --- NUEVO: Estilo Botón Flotante Ayuda --- */
        #maia-fab-help {
            position: fixed; /* Fixed position relative to viewport */
            bottom: 2rem;
            right: 2rem;
            width: 4.5rem; /* 72px */
            height: 4.5rem; /* 72px */
            background-color: #2563eb; /* blue-600 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100; /* Ensure it's above other content */
            transition: transform 0.2s ease-out;
        }
        #maia-fab-help:active {
            transform: scale(0.95);
        }
         #maia-fab-help svg {
             width: 2.5rem; /* 40px */
             height: 2.5rem; /* 40px */
             color: white;
         }


        /* --- ESTILOS DEL SIMULADOR --- */
        #simulator-container { font-family: 'Roboto', sans-serif; width: 360px; height: 740px; /* Slightly smaller */ border: 6px solid black; border-radius: 36px; overflow: hidden; position: relative; background-color: #fff; display: flex; flex-direction: column; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        #simulator-container .screen { display: none; flex-direction: column; flex-grow: 1; height: 100%; width: 100%; position: absolute; top: 0; left:0; background-color: white; transition: transform .3s ease-in-out; transform: translateX(100%); }
        #simulator-container .screen.active { display: flex; transform: translateX(0); z-index: 1;}
        #simulator-container .screen.moving-out { transform: translateX(-100%); }
        #simulator-container #status-bar { display: flex; justify-content: space-between; padding: 10px 20px; font-size: 14px; font-weight: 500; position: absolute; top: 0; left: 0; right: 0; z-index: 1000; color: black;}
        #simulator-container #phone-home-screen { background-image: url('https://i.imgur.com/8z3y3wO.jpg'); background-size: cover; background-position: center; z-index: 2; }
        #simulator-container .phone-home-main { display: flex; align-items: flex-start; padding: 70px 15px; flex-grow: 1;}
        #simulator-container .app-icon { display: flex; flex-direction: column; align-items: center; background: none; border: none; cursor: pointer; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); font-size: 12px; width: 70px; text-align: center; }
        #simulator-container .app-icon-img-container { position: relative; width: 55px; height: 55px; margin-bottom: 4px; }
        #simulator-container .app-icon-img-container img { width: 100%; height: 100%; border-radius: 10px; }
        #simulator-container .notification-badge { position: absolute; background-color: red; color: white; border-radius: 50%; padding: 1px 5px; font-size: 11px; font-weight: bold; border: 1px solid white; line-height: 1.1; }
        #simulator-container .app-badge-1 { top: -6px; right: -12px; }
        #simulator-container .app-badge-2 { top: -6px; left: -12px; background-color: #f5a623;}
        #simulator-container #login-screen { background-color: #FF6600; color: white; z-index: 3;}
        #simulator-container .login-header { padding: 50px 15px 15px; text-align: center; }
        #simulator-container .logo { width: 160px; }
        #simulator-container .login-main { text-align: center; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 18px; flex-grow: 1; }
        #simulator-container .login-main h1 { font-size: 24px; font-weight: 500; }
        #simulator-container .btn { border: none; border-radius: 20px; padding: 12px 18px; font-size: 15px; cursor: pointer; width: 100%; max-width: 280px; font-weight: bold;}
        #simulator-container .btn-primary { background-color: white; color: #FF6600; }
        #simulator-container .link { color: white; text-decoration: none; font-size: 13px; }
        #simulator-container #pin-screen { background-color: white; color: #333; justify-content: space-between; z-index: 10; }
        #simulator-container .modal-header { padding: 8px; text-align: right; }
        #simulator-container .close-btn { background: none; border: none; font-size: 26px; cursor: pointer; color: #aaa; }
        #simulator-container .pin-main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 30px 15px; }
        #simulator-container .pin-lock-icon { width: 50px; height: 50px; background-color: #e0e0e0; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 18px; }
        #simulator-container .pin-lock-icon svg { width: 25px; height: 25px; fill: #004481; }
        #simulator-container .pin-main h2 { font-size: 20px; font-weight: 500; margin-bottom: 18px; }
        #simulator-container .pin-inputs { display: flex; gap: 12px; margin-bottom: 18px; }
        #simulator-container .pin-box { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #555; }
        #simulator-container .pin-box.filled { background-color: #004481; border-color: #004481;}
        #simulator-container .pin-error-message { color: #d9534f; font-size: 13px; height: 18px; }
        #simulator-container .pin-inputs.shake { animation: shake 0.5s; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #simulator-container .keypad-footer { background-color: #d1d5db; padding-top: 4px; }
        #simulator-container .keypad-actions { display: flex; justify-content: space-between; padding: 8px 15px; align-items: center; }
        #simulator-container .btn-keypad-action-primary { color: #007aff; background: none; border: none; font-size: 15px; font-weight: bold; cursor: pointer; }
        #simulator-container .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: #acb1b8; }
        #simulator-container .keypad-btn { background-color: white; border: none; font-size: 24px; padding: 12px 0; cursor: pointer; font-weight: 300; }
        #simulator-container .keypad-btn:active { background-color: #e0e0e0; }
        #simulator-container #home-screen { background-color: #f0f2f5; z-index: 4; }
        #simulator-container .home-header { position: relative; color: white; }
        #simulator-container .home-header-wavy { background-color: #004481; height: 130px; border-bottom-left-radius: 50% 25px; border-bottom-right-radius: 50% 25px; }
        #simulator-container .home-header-content { position: absolute; top: 35px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; }
        #simulator-container .logo-small { width: 35px; }
        #simulator-container .home-main { padding: 15px; margin-top: -70px; flex-grow: 1; overflow-y: auto; }
        #simulator-container .card { background-color: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 18px; }
        #simulator-container .account-summary { display: flex; justify-content: space-between; align-items: flex-start; }
        #simulator-container .account-summary h3 { font-size: 24px; font-weight: bold; color: #004481; margin: 4px 0; }
        #simulator-container .balance-label { font-size: 11px; color: #777; }
        #simulator-container .bottom-nav { display: flex; justify-content: space-around; background-color: white; border-top: 1px solid #e0e0e0; padding-top: 4px; }
        #simulator-container .nav-item { display: flex; flex-direction: column; align-items: center; background: none; border: none; font-size: 11px; color: #777; cursor: pointer; padding: 4px; }
        #simulator-container .nav-item.active { color: #004481; }
        #simulator-container .nav-item svg { width: 22px; height: 22px; fill: #777; margin-bottom: 2px; }
        #simulator-container .nav-item.active svg { fill: #004481; }
        #simulator-container .transfer-bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background-color: white; border-top-left-radius: 15px; border-top-right-radius: 15px; padding: 15px; z-index: 50; transform: translateY(100%); transition: transform .3s ease-out; }
        #simulator-container .transfer-bottom-sheet.active { transform: translateY(0); }
        #simulator-container #recipient-screen, #transfer-details-screen, #confirmation-screen { background-color: #f7f7f7; z-index: 5; }
        #simulator-container .standard-header { display: flex; align-items: center; padding: 12px; background-color: white; }
        #simulator-container .back-btn { background: none; border: none; cursor: pointer; padding: 5px;}
        #simulator-container .back-btn svg { width: 26px; height: 26px; fill: #555; }
        #simulator-container .standard-header h2 { font-size: 16px; font-weight: 500; margin: 0 auto; transform: translateX(-13px); }
        #simulator-container .recipient-main { padding: 15px; flex-grow: 1; overflow-y: auto; }
        #simulator-container .contact-item { display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; background-color: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);}
        #simulator-container .contact-avatar { width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; flex-shrink: 0; font-size: 14px;}
        #simulator-container .contact-info p { margin: 1px 0; line-height: 1.3;}
        #simulator-container .contact-name { font-weight: 500; font-size: 15px;}
        #simulator-container .contact-details { font-size: 13px; color: #666;}
        #simulator-container .transfer-details-main { flex-grow: 1; overflow-y: auto; padding: 15px; }
        #simulator-container .details-section { background-color: white; padding: 12px; border-radius: 8px; margin-bottom: 18px; }
        #simulator-container .details-section h3 { font-size: 13px; color: #555; margin-bottom: 5px; font-weight: normal;}
        #simulator-container .details-section p { font-size: 15px; margin: 2px 0;}
        #simulator-container .form-input { width: 100%; border: none; background: none; padding: 8px 0; font-size: 22px; font-weight: bold; }
        #simulator-container .form-input:focus { outline: none; }
        #simulator-container .sticky-footer { background-color: white; padding: 15px; border-top: 1px solid #e0e0e0; position: absolute; bottom: 0; left: 0; right: 0; }
        #simulator-container .btn-primary-gray { background-color: #e0e0e0; color: #aaa; width: 100%; padding: 12px; font-size: 16px; border-radius: 20px;}
        #simulator-container .btn-primary-gray.active { background-color: #004481; color: white; }
        #simulator-container .confirmation-main { padding: 15px; }
        #simulator-container .confirmation-summary { text-align: center; background-color: white; padding: 18px; border-radius: 8px; margin-bottom: 18px;}
        #simulator-container .confirmation-summary p { font-size: 16px; margin-bottom: 5px;}
        #simulator-container .confirmation-summary h2 { font-size: 28px; font-weight: bold; color: #004481; }
        #simulator-container .confirmation-details { background-color: white; border-radius: 8px; padding: 12px; margin-bottom: 18px; }
        #simulator-container .detail-row { display: flex; justify-content: space-between; padding: 8px; font-size: 15px;}
        #simulator-container .authorization-section h3 { font-size: 14px; color: #555; margin-bottom: 10px; font-weight: normal; text-align: center;}
        #simulator-container .authorization-section .btn { width: 100%; margin-bottom: 8px; border: 1px solid #004481; padding: 12px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        #simulator-container .authorization-section .btn svg {width: 20px; height: 20px; fill: currentColor;}
        #simulator-container .btn-primary-alt { background-color: #004481; color: white; }
        #simulator-container .btn-secondary-alt { background-color: white; color: #004481; }
        #simulator-container .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: flex-end; z-index: 20; opacity: 0; transition: opacity .3s ease; pointer-events: none;}
        #simulator-container .modal-overlay.active { opacity: 1; pointer-events: auto; }
        #simulator-container .be-pass-modal { background-color: white; width: 100%; border-top-left-radius: 15px; border-top-right-radius: 15px; transform: translateY(100%); transition: transform .3s ease-out; }
        #simulator-container .modal-overlay.active .be-pass-modal { transform: translateY(0); }
        #simulator-container .be-pass-icon svg { fill: #004481; }
        #simulator-container .receipt-header { background-color: #17a63a; color: white; text-align: center; padding: 25px 15px; }
        #simulator-container .success-icon { width: 45px; height: 45px; border: 2px solid white; border-radius: 50%; margin: 0 auto 12px; display: flex; justify-content: center; align-items: center; }
        #simulator-container .success-icon svg { width: 25px; height: 25px; fill: white; }
        #simulator-container .receipt-header h2 { font-size: 18px; font-weight: 500;}
        #simulator-container .receipt-main { background-color: white; padding: 15px; flex-grow: 1; }
        #simulator-container .receipt-footer { background-color: white; }
        #simulator-container .receipt-footer button { width: 100%; border-radius: 20px; font-size: 16px; padding: 12px;}
    </style>
</head>
<body class="bg-gray-50 maia-body">

    <div id="maia-app-container" class="main-container">
        <!-- Cabecera -->
        <header id="app-header" class="p-6 border-b bg-white hidden">
             <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a15.045 15.045 0 01-7.5 0C4.508 19.64 2.25 15.223 2.25 10.5c0-1.25.223-2.454.634-3.582M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                    <h1 class="text-2xl font-bold tracking-tighter text-gray-800">MAIA</h1>
                </div>
                <button id="back-button" class="hidden text-gray-600 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    <span class="sr-only">Volver</span>
                </button>
            </div>
            <p class="text-gray-500 text-sm mt-1">Modelo de Aprendizaje e Inclusión Autónoma</p>
        </header>

        <main class="flex-grow flex flex-col">
            <!-- Pantalla Inicio -->
             <section id="screen-start" class="flex flex-col flex-grow items-center justify-center p-8">
                 <div class="text-center mb-12">
                    <div class="flex items-center justify-center space-x-3">
                        <svg class="w-12 h-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a15.045 15.045 0 01-7.5 0C4.508 19.64 2.25 15.223 2.25 10.5c0-1.25.223-2.454.634-3.582M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        <h1 class="text-7xl font-extrabold tracking-tighter text-gray-800">MAIA</h1>
                    </div>
                    <p class="text-gray-500 text-xl mt-2">Modelo de Aprendizaje e Inclusión Autónoma</p>
                </div>
                <button onclick="navigateTo('screen-categories')" class="big-button bg-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Comenzar</button>
            </section>
             <!-- Pantalla Categorías -->
             <section id="screen-categories" class="flex-grow flex flex-col p-8 hidden">
                 <h2 class="text-5xl font-bold text-gray-800 mb-10 text-center">¿Sobre qué te gustaría aprender hoy?</h2>
                <div class="space-y-6">
                    <button onclick="navigateTo('screen-money')" class="big-button bg-orange-500">Dinero</button>
                    <button class="big-button bg-green-500 opacity-50 cursor-not-allowed">Salud</button>
                    <button class="big-button bg-blue-500 opacity-50 cursor-not-allowed">Redes sociales</button>
                </div>
            </section>
             <!-- Pantalla Dinero -->
             <section id="screen-money" class="flex-grow flex flex-col p-8 bg-orange-500 hidden">
                 <h2 class="text-6xl font-bold text-white mb-10">Dinero</h2>
                <div class="space-y-6">
                    <button onclick="navigateTo('screen-simulator-intro')" class="big-button bg-white text-gray-800 !text-4xl !py-10">Transferencias bancarias</button>
                    <button class="big-button bg-white text-gray-800 !text-4xl !py-10 opacity-50 cursor-not-allowed">Pago de cuentas</button>
                    <button class="big-button bg-white text-gray-800 !text-4xl !py-10 opacity-50 cursor-not-allowed">Consultar tu saldo</button>
                </div>
            </section>
             <!-- Pantalla Intro Simulador -->
            <section id="screen-simulator-intro" class="flex flex-col flex-grow items-center justify-center p-8 text-center hidden">
                  <h2 class="text-5xl font-bold text-gray-800 mb-6">¡Vamos a practicar!</h2>
                 <p class="text-2xl text-gray-600 mb-12 max-w-2xl">A continuación, usarás un simulador para aprender a hacer una transferencia. <strong class="text-green-600">No te preocupes, es solo una práctica y no usarás dinero real.</strong></p>
                 <button onclick="navigateTo('screen-simulator')" class="big-button bg-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Empezar Práctica</button>
            </section>
             <!-- Pantalla Simulador -->
             <section id="screen-simulator" class="flex-grow flex-col hidden">
                 <div class="simulator-wrapper">
                    <div id="simulator-container">
                        <!-- El JS del simulador poblará esto -->
                    </div>
                </div>
            </section>
             <!-- Pantalla Continuar a Real -->
            <section id="screen-continue-to-real" class="flex flex-col flex-grow items-center justify-center p-8 text-center hidden">
                  <h2 class="text-5xl font-bold text-gray-800 mb-6">¡Excelente práctica!</h2>
                 <p class="text-2xl text-gray-600 mb-12 max-w-2xl">Ahora que ya sabes cómo funciona, ¿te animas a hacer una transferencia real en tu propio celular?</p>
                 <div class="w-full max-w-md space-y-6">
                    <button onclick="navigateTo('screen-tutorial')" class="big-button bg-green-500">¡Sí, vamos!</button>
                    <button onclick="navigateTo('screen-start')" class="text-xl text-gray-600 hover:text-gray-900 font-bold py-4 px-6 rounded-lg">No, terminar por ahora</button>
                 </div>
            </section>
             <!-- Pantalla Tutorial Videos -->
             <section id="screen-tutorial" class="flex-grow flex flex-col hidden bg-gray-100">
                <div class="p-8">
                    <p class="text-2xl text-gray-500">Guía para transferencia real</p>
                    <div class="flex items-center gap-4">
                        <h2 id="tutorial-step-title" class="text-5xl font-bold text-gray-800 mt-2"></h2>
                    </div>
                </div>
                <div id="video-container" class="w-full flex-grow bg-black flex items-center justify-center p-4">
                    <!-- YouTube iframe se insertará aquí -->
                </div>
                <div class="bg-gray-800 p-4 flex items-center justify-center space-x-2 sm:space-x-4">
                    <button id="tutorial-prev" class="text-white bg-gray-700 rounded-full p-4 hover:bg-gray-600 disabled:opacity-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                    <button id="help-button-tutorial" class="text-white bg-blue-600 rounded-full p-4 hover:bg-blue-700 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                    <button id="tutorial-next" class="text-white bg-gray-700 rounded-full p-4 hover:bg-gray-600 disabled:opacity-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></button>
                </div>
            </section>
         </main>
          <!-- Modal de Ayuda -->
         <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
            <div id="help-modal-content" class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-2xl w-full">
                <div class="flex justify-between items-start">
                    <h3 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">✨ ¿Necesitas ayuda?</h3>
                    <button id="close-help-modal" class="text-gray-400 hover:text-gray-800"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <p id="listen-status" class="text-lg text-gray-600 mb-6 text-center">Presiona el micrófono y haz tu pregunta. Por ejemplo: "¿Qué es un destinatario?"</p>
                <div class="flex justify-center mb-6">
                    <button id="listen-button" class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-white transition-colors hover:bg-blue-700">
                        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93V17h-1v-2.07A5 5 0 015 10v-1h1v1a4 4 0 008 0v-1h1v1a5 5 0 01-4 4.93z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                <div id="answer-container" class="mt-8 hidden">
                    <h4 class="text-2xl font-bold text-gray-800 mb-2">Respuesta de MAIA:</h4>
                    <div class="bg-blue-50 p-6 rounded-lg text-xl text-gray-800 prose max-w-none"><p id="answer-text"></p></div>
                </div>
            </div>
        </div>

         <!-- Botón Flotante de Ayuda -->
         <button id="maia-fab-help" class="hidden" title="Pedir ayuda a MAIA">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
            </svg>
         </button>
    </div>

    <script>
        // --- API Key ---
        const apiKey = "AIzaSyAgNKRCZa_cZmcFl456RCelgDAPvF4iRLw"; // <-- PONER TU CLAVE API AQUÍ

        // --- LÓGICA GENERAL DE MAIA ---
        const maiaScreens = document.querySelectorAll('#maia-app-container > main > section');
        const header = document.getElementById('app-header');
        const backButton = document.getElementById('back-button');
        const fabHelpButton = document.getElementById('maia-fab-help');
        let navigationHistory = ['screen-start'];

        // --- Variables Globales para STT (definidas fuera de DOMContentLoaded) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let listenButton = null;
        let listenStatus = null;


        function navigateTo(screenId) {
            handleReadAloud(''); // Stop speaking on navigation
            maiaScreens.forEach(s => s.classList.add('hidden'));
            const nextScreen = document.getElementById(screenId);
            if (nextScreen) { nextScreen.classList.remove('hidden'); }
            else { console.error(`Screen ${screenId} not found!`); document.getElementById('screen-start').classList.remove('hidden'); screenId = 'screen-start'; }

            const isStartScreen = screenId === 'screen-start';
            if (header) header.classList.toggle('hidden', isStartScreen);
            if (backButton) backButton.classList.toggle('hidden', isStartScreen);
            if (fabHelpButton) fabHelpButton.classList.toggle('hidden', isStartScreen);

            if (!isStartScreen) {
                if (navigationHistory[navigationHistory.length - 1] !== screenId) {
                    navigationHistory.push(screenId);
                }
            } else {
                navigationHistory = ['screen-start'];
            }

            let guidanceText = "";
            switch(screenId) { /* ... Cases sin cambios ... */ }
            if (guidanceText) setTimeout(() => handleReadAloud(guidanceText), 350);

            if (screenId === 'screen-simulator') { startSimulator(); }
            if (screenId === 'screen-tutorial') { loadStep(0); }
        }

        if (backButton) { backButton.addEventListener('click', () => { /* ... Lógica botón volver sin cambios ... */ }); }
        if (fabHelpButton) { fabHelpButton.addEventListener('click', openHelp); }


        // --- LÓGICA DEL TUTORIAL CON VIDEOS ---
        const tutorialSteps = [ /* ... Definición steps sin cambios ... */ ];
        let currentStepIndex = 0;
        const stepTitleElement = document.getElementById('tutorial-step-title');
        const tutorialPrevButton = document.getElementById('tutorial-prev');
        const tutorialNextButton = document.getElementById('tutorial-next');
        const videoContainer = document.getElementById('video-container');
        function loadStep(index) { /* ... Lógica loadStep sin cambios ... */ }
        if (tutorialNextButton) tutorialNextButton.addEventListener('click', () => { /* ... */ });
        if (tutorialPrevButton) tutorialPrevButton.addEventListener('click', () => { /* ... */ });


        // --- LÓGICA DEL ASISTENTE DE VOZ (MAIA) ---
        // --- TTS con Gemini ---
        let currentAudio = null; let audioQueue = []; let isSpeaking = false;
        async function handleReadAloud(textToRead) { /* ... Lógica handleReadAloud sin cambios ... */ }
        async function processAudioQueue() { /* ... Lógica processAudioQueue sin cambios ... */ }
        async function generateTtsAudio(text) { /* ... Lógica generateTtsAudio sin cambios ... */ }
        function playAudio(base64Data, mimeType) { /* ... Lógica playAudio sin cambios ... */ }
        function base64ToArrayBuffer(base64) { /* ... sin cambios ... */ }
        function pcmToWav(pcmData, sampleRate) { /* ... sin cambios ... */ }
        function writeString(view, offset, string) { /* ... sin cambios ... */ }
        // --- FIN TTS con Gemini ---

        // --- STT (Oído) ---
        // (Inicialización y asignación de handlers movida a DOMContentLoaded)

        // --- Llamada a Gemini LLM ---
        async function askRealGemini(userQuestion) { /* ... Lógica askRealGemini sin cambios ... */ }

        // --- Lógica del Modal de Ayuda ---
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-modal');
        const helpButtonTutorial = document.getElementById('help-button-tutorial');

        if (helpButtonTutorial) {
             helpButtonTutorial.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                openHelp();
            });
        }

        function openHelp() {
            handleReadAloud(''); // Detener voz proactiva
            if (helpModal) {
                // CORRECCIÓN: Obtener elementos AQUI, dentro de openHelp
                // Assign to global variables
                listenButton = document.getElementById('listen-button');
                listenStatus = document.getElementById('listen-status');

                if (!listenButton || !listenStatus) {
                     console.error("Could not find listen button or status inside openHelp!");
                     // Attempt to show modal anyway, but disable listening
                     helpModal.classList.remove('hidden');
                     setTimeout(() => helpModal.classList.add('active'), 10);
                     const answerContainer = document.getElementById('answer-container');
                     if (answerContainer) answerContainer.classList.add('hidden');
                     // Display error if possible
                     const tempStatus = document.getElementById('listen-status'); // Try finding it again just in case
                     if(tempStatus) tempStatus.textContent = "Error: No se encontró el botón del micrófono.";
                     return; // Salir si los elementos no existen
                }

                 // CORRECCIÓN: Add event listener HERE, only once if not already added
                 // Check if listener already exists to avoid duplicates
                 if (!listenButton.dataset.listenerAttached) {
                     listenButton.addEventListener('click', () => {
                        try {
                          if (recognition && !listenButton.classList.contains('listening')) {
                              recognition.start();
                              listenButton.disabled = true;
                          }
                        } catch (e) {
                           console.error("Error starting recognition:", e);
                           if(listenStatus) listenStatus.textContent = "Error al iniciar escucha. ¿Permitiste el micrófono?";
                           if(listenButton) listenButton.disabled = false;
                        }
                     });
                     listenButton.dataset.listenerAttached = 'true'; // Mark as attached
                 }


                helpModal.classList.remove('hidden');
                setTimeout(() => helpModal.classList.add('active'), 10);
                const answerContainer = document.getElementById('answer-container');
                if (answerContainer) answerContainer.classList.add('hidden');
                listenStatus.textContent = "Presiona el micrófono y haz tu pregunta...";
                listenButton.disabled = false;
                listenButton.classList.remove('listening');
            } else { console.error("Help modal element not found!"); }
        }


        function closeHelp() {
            handleReadAloud('');
            if (recognition && listenButton && listenButton.classList.contains('listening')) {
                recognition.abort();
            }
            if (helpModal) {
                helpModal.classList.remove('active');
                setTimeout(() => helpModal.classList.add('hidden'), 300);
            }
        }

       if (closeHelpButton) closeHelpButton.addEventListener('click', closeHelp);

        // --- LÓGICA DEL SIMULADOR ---
        function startSimulator() { /* ... Código startSimulator sin cambios, usa handleReadAloud ... */ }
        // --- FIN DE LA LÓGICA DEL SIMULADOR ---

        // Initialize the first screen and STT on load
        document.addEventListener('DOMContentLoaded', () => {
             // Initialize STT Object globally if supported
             if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = false;
                recognition.interimResults = false;

                // Assign event handlers to the global recognition object
                 recognition.onstart = () => {
                    // Query elements *inside* the handler, as they might not exist yet globally
                    const currentListenStatus = document.getElementById('listen-status');
                    const currentListenButton = document.getElementById('listen-button');
                    if (currentListenStatus) currentListenStatus.textContent = "Te estoy escuchando...";
                    if (currentListenButton) currentListenButton.classList.add('listening');
                 };
                 recognition.onspeechend = () => {
                     const currentListenStatus = document.getElementById('listen-status');
                     const currentListenButton = document.getElementById('listen-button');
                    if(recognition) recognition.stop();
                    if (currentListenStatus) currentListenStatus.textContent = "MAIA está pensando...";
                    if (currentListenButton) currentListenButton.classList.remove('listening');
                 };
                 recognition.onend = () => {
                     const currentListenStatus = document.getElementById('listen-status');
                     const currentListenButton = document.getElementById('listen-button');
                    if(currentListenButton && currentListenButton.disabled && !currentListenButton.classList.contains('listening')) {
                         // Let onresult/onerror handle re-enabling
                    } else if (currentListenButton && currentListenButton.classList.contains('listening')) {
                        currentListenButton.classList.remove('listening');
                        if (currentListenStatus) currentListenStatus.textContent = "Se detuvo la escucha. Intenta de nuevo.";
                        currentListenButton.disabled = false;
                    }
                 };
                 recognition.onresult = async (event) => {
                     const currentListenStatus = document.getElementById('listen-status'); // Query inside handler
                     const currentListenButton = document.getElementById('listen-button'); // Query inside handler
                     const pregunta = event.results[0][0].transcript.toLowerCase();
                     // Status already set
                     try {
                         const respuesta = await askRealGemini(pregunta);
                         const answerContainer = document.getElementById('answer-container');
                         const answerText = document.getElementById('answer-text');
                         if (answerText) answerText.textContent = respuesta;
                         if (answerContainer) answerContainer.classList.remove('hidden');
                         await handleReadAloud(respuesta);
                         if (currentListenStatus) currentListenStatus.textContent = "Presiona el micrófono para hablar...";
                     } catch (error) {
                          console.error("Error getting Gemini response:", error);
                          const errorMsg = "Hubo un problema al obtener la respuesta. Intenta de nuevo.";
                          if (currentListenStatus) currentListenStatus.textContent = errorMsg;
                          handleReadAloud("Lo siento, " + errorMsg.toLowerCase());
                     }
                     finally { if(currentListenButton) currentListenButton.disabled = false; }
                 };
                 recognition.onerror = (event) => {
                     const currentListenStatus = document.getElementById('listen-status'); // Query inside handler
                     const currentListenButton = document.getElementById('listen-button'); // Query inside handler
                     console.error("Speech recognition error:", event.error);
                     let errorMsg = "No pude entenderte. Intenta de nuevo.";
                     if (event.error === 'no-speech') { errorMsg = "No detecté que hablaras..."; }
                     else if (event.error === 'audio-capture') { errorMsg = "Problema con micrófono..."; }
                     else if (event.error === 'not-allowed') { errorMsg = "Necesito permiso para micrófono."; }
                     else if (event.error === 'network') { errorMsg = "Problema de red al escuchar."; }
                     if (currentListenStatus) currentListenStatus.textContent = errorMsg;
                    if (currentListenButton) {
                        currentListenButton.classList.remove('listening');
                        currentListenButton.disabled = false;
                    }
                 };

                 // Note: Event listener for listenButton is now added inside openHelp

            } else {
                // Handle browsers without SpeechRecognition
                console.warn("Speech Recognition not supported in this browser.");
                // Disable button if modal is opened later
            }

             // Navigate to the first screen
             if (document.getElementById('screen-start')) { navigateTo('screen-start'); }
             else { console.error("Screen 'screen-start' not found."); }
        });

    </script>
</body>
</html>

