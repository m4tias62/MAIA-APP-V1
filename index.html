<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MAIA v3.15 - Versión Estable Restaurada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES DE MAIA (Ajustados para iPad Vertical) --- */
        html, body { height: 100%; margin: 0; padding: 0; }
        body { -webkit-tap-highlight-color: transparent; display: flex; justify-content: center; align-items: flex-start; background-color: #f3f4f6; }
        .maia-body { font-family: 'Inter', sans-serif; width: 100%; max-width: 768px; min-height: 100%; background-color: #ffffff; box-shadow: 0 0 20px rgba(0,0,0,0.1); margin-left: auto; margin-right: auto; }
        .main-container { max-width: 100%; margin: auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        .big-button { display: flex; justify-content: center; align-items: center; width: 100%; padding: 2rem 1.5rem; border-radius: 1.5rem; font-size: 2.5rem; font-weight: 700; color: white; text-align: center; line-height: 1.2; transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .big-button:active { transform: scale(0.98); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .simulator-wrapper { background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; width: 100%; flex-grow: 1; padding: 2rem; }
        #help-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #help-modal.active { opacity: 1; pointer-events: auto;}
        #help-modal-content { background-color: white; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); padding: 1.5rem; max-width: 500px; width: 100%; transform: scale(0.95); transition: transform 0.3s ease; }
        #help-modal.active #help-modal-content { transform: scale(1); }
        #listen-button.listening { background-color: #ef4444; }
        #listen-button:disabled { background-color: #9ca3af; cursor: not-allowed;}
        #maia-fab-help { position: fixed; bottom: 2rem; right: 2rem; width: 4.5rem; height: 4.5rem; background-color: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 100; transition: transform 0.2s ease-out; border: none; }
        #maia-fab-help:active { transform: scale(0.95); }
         #maia-fab-help svg { width: 2.5rem; height: 2.5rem; color: white; }

        /* --- ESTILOS DEL SIMULADOR --- */
        #simulator-container { font-family: 'Roboto', sans-serif; width: 100%; max-width: 375px; height: calc(100vh - 12rem); max-height: 740px; border: 6px solid black; border-radius: 30px; overflow: hidden; position: relative; background-color: #fff; display: flex; flex-direction: column; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin: auto; }
        #simulator-container .screen { display: none; flex-direction: column; flex-grow: 1; height: 100%; width: 100%; position: absolute; top: 0; left:0; background-color: white; transition: transform .3s ease-in-out; transform: translateX(100%); }
        #simulator-container .screen.active { display: flex; transform: translateX(0); z-index: 1;}
        #simulator-container .screen.moving-out { transform: translateX(-100%); }
        /* ... (Resto de estilos del simulador) ... */
         #simulator-container #status-bar { display: flex; justify-content: space-between; padding: 10px 20px; font-size: 14px; font-weight: 500; position: absolute; top: 0; left: 0; right: 0; z-index: 1000; color: black;}
        #simulator-container #sim-phone-home-screen { background-image: url('https://i.imgur.com/8z3y3wO.jpg'); background-size: cover; background-position: center; z-index: 2; }
        #simulator-container .phone-home-main { display: flex; align-items: flex-start; padding: 70px 15px; flex-grow: 1;}
        #simulator-container .app-icon { display: flex; flex-direction: column; align-items: center; background: none; border: none; cursor: pointer; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); font-size: 12px; width: 70px; text-align: center; }
        #simulator-container .app-icon-img-container { position: relative; width: 55px; height: 55px; margin-bottom: 4px; }
        #simulator-container .app-icon-img-container img { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; }
        #simulator-container #sim-login-screen { background-color: #FF6600; color: white; z-index: 3;}
        #simulator-container .login-header { padding: 50px 15px 15px; text-align: center; }
        #simulator-container .logo { width: 160px; }
        #simulator-container .login-main { text-align: center; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 18px; flex-grow: 1; }
        #simulator-container .login-main h1 { font-size: 24px; font-weight: 500; }
        #simulator-container .btn { border: none; border-radius: 20px; padding: 12px 18px; font-size: 15px; cursor: pointer; width: 100%; max-width: 280px; font-weight: bold;}
        #simulator-container .btn-primary { background-color: white; color: #FF6600; }
        #simulator-container .link { color: white; text-decoration: none; font-size: 13px; }
        #simulator-container #sim-pin-screen { background-color: white; color: #333; justify-content: space-between; z-index: 10; }
        #simulator-container .modal-header { padding: 8px; text-align: right; }
        #simulator-container .close-btn { background: none; border: none; font-size: 26px; cursor: pointer; color: #aaa; }
        #simulator-container .pin-main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 30px 15px; }
        #simulator-container .pin-lock-icon { width: 50px; height: 50px; background-color: #e0e0e0; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 18px; }
        #simulator-container .pin-lock-icon svg { width: 25px; height: 25px; fill: #004481; }
        #simulator-container .pin-main h2 { font-size: 20px; font-weight: 500; margin-bottom: 18px; }
        #simulator-container .pin-inputs { display: flex; gap: 12px; margin-bottom: 18px; }
        #simulator-container .pin-box { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #555; }
        #simulator-container .pin-box.filled { background-color: #004481; border-color: #004481;}
        #simulator-container .pin-error-message { color: #d9534f; font-size: 13px; height: 18px; }
        #simulator-container .pin-inputs.shake { animation: shake 0.5s; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #simulator-container .keypad-footer { background-color: #d1d5db; padding-top: 4px; }
        #simulator-container .keypad-actions { display: flex; justify-content: space-between; padding: 8px 15px; align-items: center; }
        #simulator-container .btn-keypad-action-primary { color: #007aff; background: none; border: none; font-size: 15px; font-weight: bold; cursor: pointer; }
        #simulator-container .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: #acb1b8; }
        #simulator-container .keypad-btn { background-color: white; border: none; font-size: 24px; padding: 12px 0; cursor: pointer; font-weight: 300; }
        #simulator-container .keypad-btn:active { background-color: #e0e0e0; }
        #simulator-container #sim-home-screen { background-color: #f0f2f5; z-index: 4; }
        #simulator-container .home-header { position: relative; color: white; }
        #simulator-container .home-header-wavy { background-color: #004481; height: 130px; border-bottom-left-radius: 50% 25px; border-bottom-right-radius: 50% 25px; }
        #simulator-container .home-header-content { position: absolute; top: 35px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; }
        #simulator-container .logo-small { width: 35px; }
        #simulator-container .home-main { padding: 15px; margin-top: -70px; flex-grow: 1; overflow-y: auto; }
        #simulator-container .card { background-color: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 18px; }
        #simulator-container .account-summary { display: flex; justify-content: space-between; align-items: flex-start; }
        #simulator-container .account-summary h3 { font-size: 24px; font-weight: bold; color: #004481; margin: 4px 0; }
        #simulator-container .balance-label { font-size: 11px; color: #777; }
        #simulator-container .bottom-nav { display: flex; justify-content: space-around; background-color: white; border-top: 1px solid #e0e0e0; padding-top: 4px; }
        #simulator-container .nav-item { display: flex; flex-direction: column; align-items: center; background: none; border: none; font-size: 11px; color: #777; cursor: pointer; padding: 4px; }
        #simulator-container .nav-item.active { color: #004481; }
        #simulator-container .nav-item svg { width: 22px; height: 22px; fill: #777; margin-bottom: 2px; }
        #simulator-container .nav-item.active svg { fill: #004481; }
        #simulator-container .transfer-bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background-color: white; border-top-left-radius: 15px; border-top-right-radius: 15px; padding: 15px; z-index: 50; transform: translateY(100%); transition: transform .3s ease-out; }
        #simulator-container .transfer-bottom-sheet.active { transform: translateY(0); }
        #simulator-container #sim-recipient-screen, #sim-transfer-details-screen, #sim-confirmation-screen { background-color: #f7f7f7; z-index: 5; }
        #simulator-container .standard-header { display: flex; align-items: center; padding: 12px; background-color: white; }
        #simulator-container .back-btn { background: none; border: none; cursor: pointer; padding: 5px;}
        #simulator-container .back-btn svg { width: 26px; height: 26px; fill: #555; }
        #simulator-container .standard-header h2 { font-size: 16px; font-weight: 500; margin: 0 auto; transform: translateX(-13px); }
        #simulator-container .recipient-main { padding: 15px; flex-grow: 1; overflow-y: auto; }
        #simulator-container .contact-item { display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; background-color: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);}
        #simulator-container .contact-avatar { width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; flex-shrink: 0; font-size: 14px;}
        #simulator-container .contact-info p { margin: 1px 0; line-height: 1.3;}
        #simulator-container .contact-name { font-weight: 500; font-size: 15px;}
        #simulator-container .contact-details { font-size: 13px; color: #666;}
        #simulator-container .transfer-details-main { flex-grow: 1; overflow-y: auto; padding: 15px; }
        #simulator-container .details-section { background-color: white; padding: 12px; border-radius: 8px; margin-bottom: 18px; }
        #simulator-container .details-section h3 { font-size: 13px; color: #555; margin-bottom: 5px; font-weight: normal;}
        #simulator-container .details-section p { font-size: 15px; margin: 2px 0;}
        #simulator-container .form-input { width: 100%; border: none; background: none; padding: 8px 0; font-size: 22px; font-weight: bold; }
        #simulator-container .form-input:focus { outline: none; }
        #simulator-container .sticky-footer { background-color: white; padding: 15px; border-top: 1px solid #e0e0e0; position: absolute; bottom: 0; left: 0; right: 0; }
        #simulator-container .btn-primary-gray { background-color: #e0e0e0; color: #aaa; width: 100%; padding: 12px; font-size: 16px; border-radius: 20px;}
        #simulator-container .btn-primary-gray.active { background-color: #004481; color: white; }
        #simulator-container .confirmation-main { padding: 15px; }
        #simulator-container .confirmation-summary { text-align: center; background-color: white; padding: 18px; border-radius: 8px; margin-bottom: 18px;}
        #simulator-container .confirmation-summary p { font-size: 16px; margin-bottom: 5px;}
        #simulator-container .confirmation-summary h2 { font-size: 28px; font-weight: bold; color: #004481; }
        #simulator-container .confirmation-details { background-color: white; border-radius: 8px; padding: 12px; margin-bottom: 18px; }
        #simulator-container .detail-row { display: flex; justify-content: space-between; padding: 8px; font-size: 15px;}
        #simulator-container .authorization-section h3 { font-size: 14px; color: #555; margin-bottom: 10px; font-weight: normal; text-align: center;}
        #simulator-container .authorization-section .btn { width: 100%; margin-bottom: 8px; border: 1px solid #004481; padding: 12px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        #simulator-container .authorization-section .btn svg {width: 20px; height: 20px; fill: currentColor;}
        #simulator-container .btn-primary-alt { background-color: #004481; color: white; }
        #simulator-container .btn-secondary-alt { background-color: white; color: #004481; }
        #simulator-container .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: flex-end; z-index: 20; opacity: 0; transition: opacity .3s ease; pointer-events: none;}
        #simulator-container .modal-overlay.active { opacity: 1; pointer-events: auto; }
        #simulator-container .be-pass-modal { background-color: white; width: 100%; border-top-left-radius: 15px; border-top-right-radius: 15px; transform: translateY(100%); transition: transform .3s ease-out; }
        #simulator-container .modal-overlay.active .be-pass-modal { transform: translateY(0); }
        #simulator-container .be-pass-icon svg { fill: #004481; }
        #simulator-container #sim-receipt-screen { background-color: #f7f7f7; z-index: 5; }
        #simulator-container .receipt-header { background-color: #17a63a; color: white; text-align: center; padding: 25px 15px; }
        #simulator-container .success-icon { width: 45px; height: 45px; border: 2px solid white; border-radius: 50%; margin: 0 auto 12px; display: flex; justify-content: center; align-items: center; }
        #simulator-container .success-icon svg { width: 25px; height: 25px; fill: white; }
        #simulator-container .receipt-header h2 { font-size: 18px; font-weight: 500;}
        #simulator-container .receipt-main { background-color: white; padding: 15px; flex-grow: 1; }
        #simulator-container .receipt-footer { background-color: white; }
        #simulator-container .receipt-footer button { width: 100%; border-radius: 20px; font-size: 16px; padding: 12px;}
    </style>
</head>
<body class="maia-body">

    <div id="maia-app-container" class="main-container">
         <header id="app-header" class="p-4 border-b bg-white hidden"> </header>
         <main class="flex-grow flex flex-col">
            <section id="screen-start" class="flex flex-col flex-grow items-center justify-center p-6 md:p-12"> </section>
            <section id="screen-categories" class="flex-grow flex flex-col p-6 md:p-12 hidden"> </section>
            <section id="screen-money" class="flex-grow flex flex-col p-6 md:p-12 bg-orange-500 hidden"> </section>
            <section id="screen-simulator-intro" class="flex flex-col flex-grow items-center justify-center p-6 md:p-12 text-center hidden"> </section>
             <section id="screen-simulator" class="flex-grow flex flex-col hidden">
                 <div class="simulator-wrapper">
                    <div id="simulator-container">
                        </div>
                </div>
             </section>
             <section id="screen-continue-to-real" class="flex flex-col flex-grow items-center justify-center p-6 md:p-12 text-center hidden"> </section>
             <section id="screen-tutorial" class="flex-grow flex flex-col hidden bg-gray-100"> </section>
         </main>
         <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
             <div id="help-modal-content" class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-lg w-full"> </div>
         </div>
         <button id="maia-fab-help" class="hidden" title="Pedir ayuda a MAIA"> </button>
    </div>

    <script>
        // --- API Key ---
        const apiKey = ""; // <-- ¡IMPORTANTE! Reemplaza esto con tu clave API REAL

        // --- LÓGICA GENERAL DE MAIA ---
        const maiaScreens = document.querySelectorAll('#maia-app-container > main > section');
        const header = document.getElementById('app-header');
        const backButton = document.getElementById('back-button');
        const fabHelpButton = document.getElementById('maia-fab-help');
        let navigationHistory = ['screen-start'];

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let listenButton = null;
        let listenStatus = null;
        let simulatorListenersAttached = false; // Flag para listeners del simulador


        function navigateTo(screenId) {
            console.log("Navigating to:", screenId);
            handleReadAloud(''); // Stop speaking
            maiaScreens.forEach(s => s.classList.add('hidden'));
            const nextScreen = document.getElementById(screenId);
            if (nextScreen) { nextScreen.classList.remove('hidden'); }
            else { console.error(`Screen ${screenId} not found!`); document.getElementById('screen-start').classList.remove('hidden'); screenId = 'screen-start'; }

            const isStartScreen = screenId === 'screen-start';
            if (header) header.classList.toggle('hidden', isStartScreen);
            if (backButton) backButton.classList.toggle('hidden', isStartScreen);
            if (fabHelpButton) fabHelpButton.classList.toggle('hidden', isStartScreen);

            if (!isStartScreen) {
                 if (navigationHistory[navigationHistory.length - 1] !== screenId) {
                    navigationHistory.push(screenId);
                 }
             } else { navigationHistory = ['screen-start']; }

            let guidanceText = "";
             switch(screenId) {
                 case 'screen-start': guidanceText = "¡Hola! Soy MAIA. Toca el botón verde grande que dice 'Comenzar' para aprender algo nuevo."; break;
                 case 'screen-categories': guidanceText = "¿Sobre qué te gustaría aprender hoy? Tienes tres opciones: El botón naranjo dice 'Dinero'. El botón verde dice 'Salud'. Y el botón azul dice 'Redes sociales'. Toca el que prefieras."; break;
                 case 'screen-money': guidanceText = "¡Muy bien! Estás en la sección de 'Dinero'. ¿Qué quieres aprender a hacer? Toca el botón blanco que dice 'Transferencias bancarias'. Las otras opciones son 'Pago de cuentas' y 'Consultar tu saldo'."; break;
                 case 'screen-simulator-intro': guidanceText = "¡Vamos a practicar cómo hacer una transferencia! No te preocupes, esto es como un juego, es solo una práctica segura y no usarás dinero de verdad. Toca el botón azul grande que dice 'Empezar Práctica'."; break;
                 case 'screen-continue-to-real': guidanceText = "¡Terminaste la práctica! ¡Excelente! Ahora que ya sabes cómo funciona, ¿te animas a hacer una transferencia real usando tu propio celular? Toca el botón verde grande que dice '¡Sí, vamos!' o el texto de abajo si prefieres terminar por ahora."; break;
            }
             console.log("[Guidance] Text:", guidanceText || "(None)");
            if (guidanceText) setTimeout(() => handleReadAloud(guidanceText), 350);

            if (screenId === 'screen-simulator') { startSimulator(); }
            if (screenId === 'screen-tutorial') { loadStep(0); }
        }

        if (backButton) { backButton.addEventListener('click', () => { /* ... Lógica botón volver ... */ }); }
        if (fabHelpButton) { fabHelpButton.addEventListener('click', openHelp); }


        // --- LÓGICA DEL TUTORIAL CON VIDEOS ---
        const tutorialSteps = [ /* ... Definición steps ... */ ];
        let currentStepIndex = 0;
        const stepTitleElement = document.getElementById('tutorial-step-title');
        const tutorialPrevButton = document.getElementById('tutorial-prev');
        const tutorialNextButton = document.getElementById('tutorial-next');
        const videoContainer = document.getElementById('video-container');
        function loadStep(index) { /* ... Lógica loadStep (usa handleReadAloud) ... */ }
        if (tutorialNextButton) tutorialNextButton.addEventListener('click', () => { /* ... */ });
        if (tutorialPrevButton) tutorialPrevButton.addEventListener('click', () => { /* ... */ });


        // --- LÓGICA DEL ASISTENTE DE VOZ (MAIA) ---

        // --- TTS usando Voz del Navegador ---
        function handleReadAloud(textToRead) {
            console.log("[TTS Browser] Speaking:", textToRead || "(Stopping)");
             if (!('speechSynthesis' in window)) { console.warn("Speech Synthesis not supported."); return; }
            window.speechSynthesis.cancel();
            if (textToRead) {
                const utterance = new SpeechSynthesisUtterance(textToRead);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }
        // --- FIN TTS ---


        // --- STT (Oído) ---
        // (Inicialización y asignación de handlers en DOMContentLoaded)

        // --- Llamada a Gemini LLM ---
        async function askRealGemini(userQuestion) { /* ... Lógica askRealGemini con logs y fallback ... */ }


        // --- Lógica del Modal de Ayuda ---
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-modal');
        const helpButtonTutorial = document.getElementById('help-button-tutorial');

        if (helpButtonTutorial) { /* ... listener sin cambios ... */ }

        function openHelp() { /* ... Lógica openHelp (busca listenButton/Status y añade listener) ... */ }
        function closeHelp() { /* ... Lógica closeHelp sin cambios ... */ }
       if (closeHelpButton) closeHelpButton.addEventListener('click', closeHelp);

        // --- LÓGICA DEL SIMULADOR ---
        let simPinAttempts = { loginPin: '', bePassPin: '', amount: '', selectedRecipient: null };

        function startSimulator() {
             console.log("Starting Simulator...");
             simPinAttempts = { loginPin: '', bePassPin: '', amount: '', selectedRecipient: null }; // Reset state
             // --- HTML DEL SIMULADOR ---
             const SIMULATOR_HTML = `
                <div id="status-bar"><span>19:14</span></div>
                <div class="screen active" id="sim-phone-home-screen">
                    <main class="phone-home-main">
                        <button id="banco-estado-icon" class="app-icon">
                            <div class="app-icon-img-container">
                                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAASFBMVEX////tKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTXtKTZuQ4iMAAAAFnRSTlMA//////8A/wD/AP8A/wD/AP8A/wD/AP9p/Xj4AAACFUlEQVR4nO3c6W6CQBhAUG6JEAJimv//G0+lRQS0veYk+70zc4/pAWD5iF4nCAAAAAAAAAAAAAAAAAAAAAAAAAAAoJ+d0N6t8drs13r68J9E/hG9/k5fL73n+pLq8G95D3b+n71G/xz+zZ8s9H79i/+fR3/vj/o3eY/2n8K/s2f/89BP+zP+j94j+c/hX9iJPyP0jD/if87/9k/6F/z9/k/6F33M/+H/9c/6N/wV/0f6F37M/9H+xT/1/+hfsnf9f+gP+b/8X7K3/X/oD/i//R+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/oD/i//B+yd/1/6A/4v/wfsnf9f+gP+L/8H7J3/X/qL3qP/B//Onv1X9tM/2d/xv/s/+lfs1vjv5t+d/s7+rf1X9lP+Tv+Z/s1+z//F/86e/Uv2S/wnf2f/3t/tFwAAAAAAAAAAAAAAAAAAAAAAAAAAgH/1D8j/fQoQoQ+NAAAAAElFTkSuQmCC" alt="BancoEstado App Icon">
                            </div>
                            <span>BancoEstado</span>
                        </button>
                    </main>
                </div>
                <div class="screen" id="sim-login-screen"><header class="login-header"><img src="https://i.imgur.com/rNfpE6p.png" alt="BancoEstado Logo" class="logo"></header><main class="login-main"><h1>Hola Matías</h1><button class="btn btn-primary" id="login-button">Ingresar</button><a href="#" class="link">¿Olvidaste tu clave?</a></main></div>
                <div class="screen" id="sim-pin-screen"><header class="modal-header"><button class="close-btn" data-target="sim-login-screen">&times;</button></header><main class="pin-main"><div class="pin-lock-icon"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg></div><h2>Ingresa tu clave</h2><div class="pin-inputs" id="login-pin-inputs"><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div></div><p id="pin-error" class="pin-error-message"></p><a href="#" class="link">¿Problemas con tu clave?</a></main><footer class="keypad-footer"><div class="keypad-actions"><button class="btn-keypad-action-primary" id="login-pin-accept">Aceptar</button></div><div class="keypad" id="login-keypad"></div></footer></div>
                <div class="screen" id="sim-home-screen"><header class="home-header"><div class="home-header-wavy"></div><div class="home-header-content"><img src="https://i.imgur.com/rNfpE6p.png" alt="BancoEstado Logo" class="logo-small"></div></header><main class="home-main"><div class="card account-summary"><div class="account-details"><p><strong>CuentaRUT</strong> 00020334694</p><h3>$32</h3><p class="balance-label">Saldo disponible</p></div><div><button class="btn btn-secondary">Movimientos</button><button class="btn btn-secondary">Cartolas</button></div></div><div class="card"><p>Seguro Full Ambulatorio...</p></div></main><nav class="bottom-nav"><button class="nav-item active"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Inicio</button><button class="nav-item" id="transfer-nav-btn"><svg viewBox="0 0 24 24"><path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4v3zM8 5v3H2v2h6v3l4-4-4-4z"/></svg>Transferir</button><button class="nav-item"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>Seguridad</button><button class="nav-item"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>Más</button></nav><div class="transfer-bottom-sheet" id="transfer-sheet"><button data-target="sim-recipient-screen">A terceros</button></div></div>
                <div class="screen" id="sim-recipient-screen"><header class="standard-header"><button class="back-btn" data-target="sim-home-screen"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button><h2>Transferir</h2></header><main class="recipient-main"><div class="contact-list"><div class="contact-item" data-name="Maria Elena Maureira" data-rut="8.458.176-3" data-bank="BancoEstado" data-account-type="CuentaRUT" data-account-number="8458176"><div class="contact-avatar" style="background-color:#F06292;">MM</div><div class="contact-info"><p class="contact-name">Maria Elena Maureira</p><p class="contact-details">BancoEstado</p></div></div></div></main></div>
                <div class="screen" id="sim-transfer-details-screen"><header class="standard-header"><button class="back-btn" data-target="sim-recipient-screen"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button><h2>Transferir</h2></header><main class="transfer-details-main"><div class="details-section"><h3>Cuenta de origen</h3><p>CuentaRUT 00020334694</p></div><div class="details-section"><h3>Destinatario</h3><p id="dest-name"></p><p id="dest-rut"></p></div><div class="details-section"><h3>Ingresa un monto</h3><input type="text" id="transfer-amount" class="form-input" placeholder="Ej.: 5000" readonly></div></main><footer class="sticky-footer" id="transfer-details-footer"><button class="btn btn-primary-gray" id="continue-transfer-btn" disabled>Continuar</button></footer><footer class="keypad-footer" id="amount-keypad-footer" style="display: none;"><div class="keypad-actions"><button class="btn-keypad-action-primary" id="amount-keypad-done">Listo</button></div><div class="keypad" id="amount-keypad"></div></footer></div>
                <div class="screen" id="sim-confirmation-screen"><header class="standard-header"><button class="back-btn" data-target="sim-transfer-details-screen"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button><h2>Confirma y autoriza</h2></header><main class="confirmation-main"><div class="confirmation-summary"><p id="confirm-dest-name"></p><h2 id="confirm-amount"></h2></div><div class="confirmation-details"><div class="detail-row"><p>RUT</p><p id="confirm-rut"></p></div><div class="detail-row"><p>BANCO</p><p id="confirm-bank"></p></div></div><div class="authorization-section"><h3>Autorizar transferencia con:</h3><button class="btn btn-primary-alt">BE Face</button><button id="authorize-be-pass-btn" class="btn btn-secondary-alt">BE Pass</button></div></main></div>
                <div class="modal-overlay" id="sim-be-pass-modal"><div class="be-pass-modal"><header class="modal-header"><button class="close-btn" data-target="sim-confirmation-screen">&times;</button></header><main class="pin-main"><div class="be-pass-icon pin-lock-icon"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3-8H9V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2z"/></svg></div><h2>Ingresa tu clave BE Pass</h2><div class="pin-inputs" id="be-pass-pin-inputs"><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div></div><p id="be-pass-error" class="pin-error-message"></p></main><footer class="keypad-footer"><div class="keypad-actions"><button id="be-pass-pin-accept" class="btn-keypad-action-primary">Autorizar</button></div><div class="keypad" id="be-pass-keypad"></div></footer></div></div>
                <div class="screen" id="sim-receipt-screen"><header class="receipt-header"><div class="success-icon"><svg viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg></div><h2>Comprobante de Transferencia</h2></header><main class="receipt-main"><div class="detail-row"><p>Monto</p><p><strong id="receipt-amount"></strong></p></div><div class="detail-row"><p>Destinatario</p><p id="receipt-name"></p></div></main><footer class="sticky-footer receipt-footer"><button class="btn btn-secondary" id="go-home-btn">Finalizar Práctica</button></footer></div>
            `;
            const simulatorContainer = document.getElementById('simulator-container');
             if (!simulatorContainer) { console.error("Simulator container not found!"); return; }
            simulatorContainer.innerHTML = SIMULATOR_HTML;

            // Llamar a attachSimulatorListeners DESPUÉS de setear innerHTML
            attachSimulatorListeners(simulatorContainer); // Pasar la referencia

             // Guía de voz inicial
             setTimeout(() => handleReadAloud("Esta es la pantalla de inicio. Busca el ícono de BancoEstado y tócalo."), 350);
        }

        // Función separada para añadir listeners del simulador
        function attachSimulatorListeners(simulatorContainer) {
            console.log("Attaching simulator listeners...");
             if (!simulatorContainer) { console.error("Cannot attach listeners, simulator container is null."); return; }

             // --- Referencias a elementos y funciones auxiliares ---
             const simNavigate = (targetId, isBack = false) => {
                 handleReadAloud(''); // Stop speaking
                 const simTargetId = targetId.startsWith('sim-') ? targetId : `sim-${targetId}`;
                 const currentScreen = simulatorContainer.querySelector('.screen.active');
                 const nextScreen = simulatorContainer.querySelector(`#${simTargetId}`);

                 if (currentScreen && nextScreen && currentScreen.id !== simTargetId) {
                     console.log(`Sim Navigating: ${currentScreen.id} -> ${simTargetId}`);
                     if(isBack) {
                         currentScreen.classList.add('moving-out');
                         setTimeout(() => currentScreen.classList.remove('active', 'moving-out'), 300);
                     } else {
                        currentScreen.classList.remove('active');
                     }
                     nextScreen.classList.add('active');

                     let voiceGuidance = "";
                     switch(simTargetId) {
                         case 'sim-phone-home-screen': voiceGuidance = "Esta es la pantalla de inicio. Busca el ícono de BancoEstado y tócalo."; break;
                         case 'sim-login-screen': voiceGuidance = "¡Bien! Ahora toca el botón blanco grande que dice 'Ingresar'."; break;
                         case 'sim-pin-screen': voiceGuidance = "Ingresa tu clave secreta de 4 números. Recuerda, es solo una práctica segura. La clave aquí es uno, dos, tres, cuatro. Luego toca 'Aceptar'."; break;
                         case 'sim-home-screen': voiceGuidance = "¡Entraste! Esta es la pantalla principal. Para transferir, busca abajo el botón que dice 'Transferir' y tócalo."; break;
                         case 'sim-recipient-screen': voiceGuidance = "Aquí eliges a quién transferir. Para esta práctica, toca el nombre 'Maria Elena Maureira'."; break;
                         case 'sim-transfer-details-screen': voiceGuidance = "Ahora ingresa el monto. Toca donde dice 'Ingresa un monto'. No te preocupes, el dinero es de mentira."; break;
                         case 'sim-confirmation-screen': voiceGuidance = "Revisa bien los datos: el nombre y el monto. Como esto es una práctica segura, no pasará nada con tu dinero real. Toca el botón blanco 'BE Pass' para continuar."; break;
                         case 'sim-receipt-screen': voiceGuidance = "¡Listo! La transferencia de práctica se realizó con éxito. Toca el botón 'Finalizar Práctica'."; break;
                     }
                     if(voiceGuidance) setTimeout(() => handleReadAloud(voiceGuidance), 350);
                 } else if (!nextScreen) { console.error(`Sim screen ${simTargetId} not found!`); }
                   else if (currentScreen && currentScreen.id === simTargetId) { console.warn(`Sim Navigation: Already on screen ${simTargetId}`);}
            };
            const createKeypad = (keypadId, onKeyPress) => {
                 const keypad = simulatorContainer.querySelector(`#${keypadId}`);
                if(!keypad) { console.error(`Keypad container #${keypadId} not found!`); return; }
                keypad.innerHTML = '';
                const keys = [1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, 'delete'];
                keys.forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'keypad-btn';
                    if (key === 'delete') { btn.innerHTML = '&#9003;'; btn.onclick = () => onKeyPress('delete'); }
                    else if (key !== '') { btn.textContent = key; btn.onclick = () => onKeyPress(key.toString()); }
                    else { btn.style.visibility = 'hidden'; }
                    keypad.appendChild(btn);
                });
            };
            const updatePinInputs = (pin, containerId) => {
                 const container = simulatorContainer.querySelector(`#${containerId}`);
                 if (!container) return;
                const inputs = container.querySelectorAll('.pin-box');
                inputs.forEach((box, i) => { box.classList.toggle('filled', i < pin.length); });
            };
             const handlePinInput = (key, pinVar, maxLen, inputContainerId) => {
                 let newPin = simPinAttempts[pinVar] || '';
                 if (key === 'delete') { newPin = newPin.slice(0, -1); }
                 else if (typeof key === 'string' && newPin.length < maxLen) { newPin += key; }
                 simPinAttempts[pinVar] = newPin;
                 updatePinInputs(newPin, inputContainerId);
                 if (inputContainerId === 'be-pass-pin-inputs' && newPin.length === maxLen) {
                     setTimeout(() => handleReadAloud("Ingresaste los 6 números. Toca 'Autorizar'. Recuerda, es solo una práctica."), 200);
                 }
             };
             const showPinError = (containerId, errorMsgId, message) => {
                 const pinContainer = simulatorContainer.querySelector(`#${containerId}`);
                 const errorEl = simulatorContainer.querySelector(`#${errorMsgId}`);
                 if (pinContainer) pinContainer.classList.add('shake');
                 if (errorEl) errorEl.textContent = message;
                 handleReadAloud("Uy, la clave no es correcta. Intenta de nuevo.");
                 setTimeout(() => {
                     if (pinContainer) pinContainer.classList.remove('shake');
                     if (errorEl) errorEl.textContent = '';
                 }, 1000);
             };


             // --- Setup Keypads ---
             createKeypad('login-keypad', (key) => handlePinInput(key, 'loginPin', 4, 'login-pin-inputs'));
             createKeypad('be-pass-keypad', (key) => handlePinInput(key, 'bePassPin', 6, 'be-pass-pin-inputs'));
             const amountInput = simulatorContainer.querySelector('#transfer-amount');
             if (amountInput) {
                 createKeypad('amount-keypad', (key) => {
                    let currentAmount = simPinAttempts.amount || '';
                    if (key === 'delete') { currentAmount = currentAmount.slice(0, -1); }
                    else if (typeof key === 'string' && currentAmount.length < 7) { currentAmount += key; }
                    simPinAttempts.amount = currentAmount;
                    const amountNumber = parseInt(currentAmount) || 0;
                    amountInput.value = amountNumber > 0 ? new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amountNumber) : '';
                });
             } else { console.error("Amount input not found in simulator!"); }

            // --- Attach Event Listeners ---
             const bancoEstadoIcon = simulatorContainer.querySelector('#banco-estado-icon');
             if (bancoEstadoIcon) bancoEstadoIcon.addEventListener('click', () => simNavigate('sim-login-screen')); else console.error("Icono BE no encontrado");

             const loginButton = simulatorContainer.querySelector('#login-button');
             if (loginButton) loginButton.addEventListener('click', () => simNavigate('sim-pin-screen')); else console.error("Botón Login no encontrado");

             const loginPinAccept = simulatorContainer.querySelector('#login-pin-accept');
             if(loginPinAccept) loginPinAccept.addEventListener('click', () => {
                 if (simPinAttempts.loginPin === "1234") { simNavigate('sim-home-screen'); }
                 else { showPinError('login-pin-inputs', 'pin-error', 'Clave incorrecta. Intenta con 1234.'); }
                 simPinAttempts.loginPin = ''; updatePinInputs('', 'login-pin-inputs');
             }); else console.error("Botón login pin accept no encontrado");

             const transferNavBtn = simulatorContainer.querySelector('#transfer-nav-btn');
             const transferSheet = simulatorContainer.querySelector('#transfer-sheet');
             if (transferNavBtn && transferSheet) {
                  transferNavBtn.addEventListener('click', () => {
                    transferSheet.classList.toggle('active');
                    handleReadAloud("Elige 'A terceros' para enviar dinero a otra persona.");
                });
             } else console.error("Botón nav transfer o sheet no encontrado");

             const transferSheetButton = simulatorContainer.querySelector('#transfer-sheet button');
             if (transferSheetButton && transferSheet) {
                 transferSheetButton.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target; // Should be sim-recipient-screen
                    if(target) simNavigate(target);
                    transferSheet.classList.remove('active');
                });
             } else console.error("Botón sheet transfer no encontrado");

             simulatorContainer.querySelectorAll('.contact-item').forEach(item => {
                 item.addEventListener('click', () => {
                    simPinAttempts.selectedRecipient = item.dataset;
                    const destNameEl = simulatorContainer.querySelector('#dest-name');
                    const destRutEl = simulatorContainer.querySelector('#dest-rut');
                    if (destNameEl) destNameEl.textContent = simPinAttempts.selectedRecipient.name;
                    if (destRutEl) destRutEl.textContent = simPinAttempts.selectedRecipient.rut;
                    simNavigate('sim-transfer-details-screen');
                });
             });
             const continueFooter = simulatorContainer.querySelector('#transfer-details-footer');
             const amountKeypadFooter = simulatorContainer.querySelector('#amount-keypad-footer');
             const continueBtn = simulatorContainer.querySelector('#continue-transfer-btn');
             if (amountInput && continueFooter && amountKeypadFooter) {
                 amountInput.addEventListener('click', () => {
                    if (continueFooter) continueFooter.style.display = 'none';
                    if (amountKeypadFooter) amountKeypadFooter.style.display = 'block';
                    handleReadAloud("Usa el teclado numérico para escribir cuánto dinero quieres enviar. Luego toca 'Listo'.");
                });
             } else { console.error("Elementos amount input/footer no encontrados"); }

             const amountKeypadDone = simulatorContainer.querySelector('#amount-keypad-done');
             if (amountKeypadDone && continueFooter && amountKeypadFooter && continueBtn) {
                 amountKeypadDone.addEventListener('click', () => {
                    if (continueFooter) continueFooter.style.display = 'block';
                    if (amountKeypadFooter) amountKeypadFooter.style.display = 'none';
                    const amount = parseInt(simPinAttempts.amount || '0');
                    if (continueBtn) {
                        continueBtn.disabled = amount <= 0;
                        continueBtn.classList.toggle('active', !continueBtn.disabled);
                        if (!continueBtn.disabled) { handleReadAloud("¡Bien! Ahora toca el botón azul 'Continuar' que apareció abajo."); }
                        else { handleReadAloud("Debes ingresar un monto mayor que cero."); }
                    }
                });
             } else { console.error("Botón amount done o footers no encontrados"); }

             if (continueBtn) {
                 continueBtn.addEventListener('click', () => {
                    if(!continueBtn.disabled && simPinAttempts.selectedRecipient && amountInput) {
                        const recipient = simPinAttempts.selectedRecipient;
                        const confirmDestName = simulatorContainer.querySelector('#confirm-dest-name');
                        const confirmAmount = simulatorContainer.querySelector('#confirm-amount');
                        const confirmRut = simulatorContainer.querySelector('#confirm-rut');
                        const confirmBank = simulatorContainer.querySelector('#confirm-bank');
                        if (confirmDestName) confirmDestName.textContent = recipient.name;
                        if (confirmAmount) confirmAmount.textContent = amountInput.value;
                        if (confirmRut) confirmRut.textContent = recipient.rut;
                        if (confirmBank) confirmBank.textContent = recipient.bank;
                        simNavigate('sim-confirmation-screen');
                    }
                });
             } else { console.error("Botón continue transfer no encontrado"); }

             const authorizeBePassBtn = simulatorContainer.querySelector('#authorize-be-pass-btn');
             const bePassModal = simulatorContainer.querySelector('#sim-be-pass-modal');
             if (authorizeBePassBtn && bePassModal) {
                 authorizeBePassBtn.addEventListener('click', () => {
                    simPinAttempts.bePassPin = '';
                    updatePinInputs('', 'be-pass-pin-inputs');
                    bePassModal.classList.add('active');
                    handleReadAloud("Ahora ingresa tu clave BePass de 6 números. Para esta práctica es seis, cinco, cuatro, tres, dos, uno.");
                });
             } else { console.error("Botón auth be pass o modal no encontrado"); }

             const bePassPinAccept = simulatorContainer.querySelector('#be-pass-pin-accept');
             if (bePassPinAccept && amountInput && bePassModal) {
                 bePassPinAccept.addEventListener('click', () => {
                    if (simPinAttempts.bePassPin === "654321" && simPinAttempts.selectedRecipient) {
                        const receiptAmount = simulatorContainer.querySelector('#receipt-amount');
                        const receiptName = simulatorContainer.querySelector('#receipt-name');
                        if (receiptAmount) receiptAmount.textContent = amountInput.value;
                        if (receiptName) receiptName.textContent = simPinAttempts.selectedRecipient.name;
                        simNavigate('sim-receipt-screen');
                        bePassModal.classList.remove('active');
                    } else {
                        showPinError('be-pass-pin-inputs', 'be-pass-error', 'Clave incorrecta. Intenta con 654321.');
                        simPinAttempts.bePassPin = '';
                        updatePinInputs('', 'be-pass-pin-inputs');
                    }
                });
             } else { console.error("Botón be pass accept, amount input o modal no encontrado"); }

             simulatorContainer.querySelectorAll('.back-btn, .close-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target; // Target ID should be prefixed
                    if (target) simNavigate(target, true);
                    const modal = e.currentTarget.closest('.modal-overlay');
                    if (modal) modal.classList.remove('active');
                });
             });
             const goHomeBtn = simulatorContainer.querySelector('#go-home-btn');
             if (goHomeBtn) goHomeBtn.addEventListener('click', () => navigateTo('screen-continue-to-real')); else console.error("Botón go home (receipt) no encontrado");

             console.log("Simulator listeners attached successfully.");
        }
        // --- FIN DE LA LÓGICA DEL SIMULADOR ---

        // Initialize the first screen and STT on load
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOMContentLoaded event fired.");
             // Initialize STT Object globally if supported
             if (SpeechRecognition) {
                 try {
                    recognition = new SpeechRecognition();
                    recognition.lang = 'es-ES';
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    // Assign event handlers
                    recognition.onstart = () => { /* ... query elements inside ... */ };
                    recognition.onspeechend = () => { /* ... query elements inside ... */ };
                    recognition.onend = () => { /* ... query elements inside ... */ };
                    recognition.onresult = async (event) => { /* ... query elements inside ... */ };
                    recognition.onerror = (event) => { /* ... query elements inside ... */ };
                    console.log("SpeechRecognition initialized successfully.");
                 } catch(e) { console.error("Error initializing SpeechRecognition:", e); recognition = null; }
             } else { console.warn("Speech Recognition not supported."); }

             // Navigate to the first screen
             if (document.getElementById('screen-start')) { navigateTo('screen-start'); }
             else { console.error("Screen 'screen-start' not found."); }
        });

    </script>
</body>
</html>
