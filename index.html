<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MAIA v2.6 - Integración Gemini API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES DE MAIA --- */
        body { -webkit-tap-highlight-color: transparent; }
        .maia-body { font-family: 'Inter', sans-serif; }
        .main-container { max-width: 1024px; margin: auto; min-height: 100vh; display: flex; flex-direction: column; }
        .big-button { display: flex; justify-content: center; align-items: center; width: 100%; padding: 2.5rem 1.5rem; border-radius: 1.5rem; font-size: 3rem; font-weight: 700; color: white; text-align: center; line-height: 1.2; transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .big-button:active { transform: scale(0.98); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .simulator-wrapper { background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; width: 100%; flex-grow: 1; padding: 2rem 0;}
        #help-modal.active #help-modal-content { transform: scale(1); opacity: 1; }
        #help-modal-content { transition: opacity 0.3s ease, transform 0.3s ease; transform: scale(0.95); opacity: 0; }
        #listen-button.listening { background-color: #ef4444; } /* Rojo mientras escucha */
        #listen-button:disabled { background-color: #9ca3af; cursor: not-allowed;} /* Gris cuando está deshabilitado (pensando) */


        /* --- ESTILOS DEL SIMULADOR --- */
        #simulator-container { font-family: 'Roboto', sans-serif; width: 375px; height: 812px; border: 8px solid black; border-radius: 40px; overflow: hidden; position: relative; background-color: #fff; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #simulator-container .screen { display: none; flex-direction: column; flex-grow: 1; height: 100%; width: 100%; position: absolute; top: 0; left:0; background-color: white; transition: transform .3s ease-in-out; transform: translateX(100%); }
        #simulator-container .screen.active { display: flex; transform: translateX(0); z-index: 1;}
        #simulator-container .screen.moving-out { transform: translateX(-100%); }
        #simulator-container #status-bar { display: flex; justify-content: space-between; padding: 12px 25px; font-size: 15px; font-weight: 500; position: absolute; top: 0; left: 0; right: 0; z-index: 1000; color: black;}
        #simulator-container #phone-home-screen { background-image: url('https://i.imgur.com/8z3y3wO.jpg'); background-size: cover; background-position: center; z-index: 2; }
        #simulator-container .phone-home-main { display: flex; align-items: flex-start; padding: 80px 20px; flex-grow: 1;}
        #simulator-container .app-icon { display: flex; flex-direction: column; align-items: center; background: none; border: none; cursor: pointer; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); font-size: 14px; width: 80px; text-align: center; }
        #simulator-container .app-icon-img-container { position: relative; width: 60px; height: 60px; margin-bottom: 5px; }
        #simulator-container .app-icon-img-container img { width: 100%; height: 100%; border-radius: 12px; }
        #simulator-container .notification-badge { position: absolute; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold; border: 2px solid white; line-height: 1.2; }
        #simulator-container .app-badge-1 { top: -8px; right: -15px; }
        #simulator-container .app-badge-2 { top: -8px; left: -15px; background-color: #f5a623;}
        #simulator-container #login-screen { background-color: #FF6600; color: white; z-index: 3;}
        #simulator-container .login-header { padding: 60px 20px 20px; text-align: center; }
        #simulator-container .logo { width: 180px; }
        #simulator-container .login-main { text-align: center; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 20px; flex-grow: 1; }
        #simulator-container .login-main h1 { font-size: 28px; font-weight: 500; }
        #simulator-container .btn { border: none; border-radius: 25px; padding: 15px 20px; font-size: 16px; cursor: pointer; width: 100%; max-width: 300px; font-weight: bold;}
        #simulator-container .btn-primary { background-color: white; color: #FF6600; }
        #simulator-container .link { color: white; text-decoration: none; font-size: 14px; }
        #simulator-container #pin-screen { background-color: white; color: #333; justify-content: space-between; z-index: 10; }
        #simulator-container .modal-header { padding: 10px; text-align: right; }
        #simulator-container .close-btn { background: none; border: none; font-size: 30px; cursor: pointer; color: #aaa; }
        #simulator-container .pin-main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 40px 20px; }
        #simulator-container .pin-lock-icon { width: 60px; height: 60px; background-color: #e0e0e0; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        #simulator-container .pin-lock-icon svg { width: 30px; height: 30px; fill: #004481; }
        #simulator-container .pin-main h2 { font-size: 22px; font-weight: 500; margin-bottom: 20px; }
        #simulator-container .pin-inputs { display: flex; gap: 15px; margin-bottom: 20px; }
        #simulator-container .pin-box { width: 15px; height: 15px; border-radius: 50%; border: 1px solid #555; }
        #simulator-container .pin-box.filled { background-color: #004481; border-color: #004481;}
        #simulator-container .pin-error-message { color: #d9534f; font-size: 14px; height: 20px; }
        #simulator-container .pin-inputs.shake { animation: shake 0.5s; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #simulator-container .keypad-footer { background-color: #d1d5db; padding-top: 5px; }
        #simulator-container .keypad-actions { display: flex; justify-content: space-between; padding: 10px 20px; align-items: center; }
        #simulator-container .btn-keypad-action-primary { color: #007aff; background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        #simulator-container .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: #acb1b8; }
        #simulator-container .keypad-btn { background-color: white; border: none; font-size: 28px; padding: 15px 0; cursor: pointer; font-weight: 300; }
        #simulator-container .keypad-btn:active { background-color: #e0e0e0; }
        #simulator-container #home-screen { background-color: #f0f2f5; z-index: 4; }
        #simulator-container .home-header { position: relative; color: white; }
        #simulator-container .home-header-wavy { background-color: #004481; height: 150px; border-bottom-left-radius: 50% 30px; border-bottom-right-radius: 50% 30px; }
        #simulator-container .home-header-content { position: absolute; top: 40px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; }
        #simulator-container .logo-small { width: 40px; }
        #simulator-container .home-main { padding: 20px; margin-top: -80px; flex-grow: 1; overflow-y: auto; }
        #simulator-container .card { background-color: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #simulator-container .account-summary { display: flex; justify-content: space-between; align-items: flex-start; }
        #simulator-container .account-summary h3 { font-size: 28px; font-weight: bold; color: #004481; margin: 5px 0; }
        #simulator-container .balance-label { font-size: 12px; color: #777; }
        #simulator-container .bottom-nav { display: flex; justify-content: space-around; background-color: white; border-top: 1px solid #e0e0e0; padding-top: 5px; }
        #simulator-container .nav-item { display: flex; flex-direction: column; align-items: center; background: none; border: none; font-size: 12px; color: #777; cursor: pointer; padding: 5px; }
        #simulator-container .nav-item.active { color: #004481; }
        #simulator-container .nav-item svg { width: 24px; height: 24px; fill: #777; margin-bottom: 3px; }
        #simulator-container .nav-item.active svg { fill: #004481; }
        #simulator-container .transfer-bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background-color: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; z-index: 50; transform: translateY(100%); transition: transform .3s ease-out; }
        #simulator-container .transfer-bottom-sheet.active { transform: translateY(0); }
        #simulator-container #recipient-screen, #transfer-details-screen, #confirmation-screen { background-color: #f7f7f7; z-index: 5; }
        #simulator-container .standard-header { display: flex; align-items: center; padding: 15px; background-color: white; }
        #simulator-container .back-btn { background: none; border: none; cursor: pointer; }
        #simulator-container .back-btn svg { width: 30px; height: 30px; fill: #555; }
        #simulator-container .standard-header h2 { font-size: 18px; font-weight: 500; margin: 0 auto; transform: translateX(-15px); }
        #simulator-container .recipient-main { padding: 20px; flex-grow: 1; overflow-y: auto; }
        #simulator-container .contact-item { display: flex; align-items: center; gap: 15px; padding: 15px; cursor: pointer; background-color: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        #simulator-container .contact-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; flex-shrink: 0;}
        #simulator-container .transfer-details-main { flex-grow: 1; overflow-y: auto; padding: 20px; }
        #simulator-container .details-section { background-color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        #simulator-container .form-input { width: 100%; border: none; background: none; padding: 10px 0; font-size: 24px; font-weight: bold; }
        #simulator-container .form-input:focus { outline: none; }
        #simulator-container .sticky-footer { background-color: white; padding: 20px; border-top: 1px solid #e0e0e0; position: absolute; bottom: 0; left: 0; right: 0; }
        #simulator-container .btn-primary-gray { background-color: #e0e0e0; color: #aaa; width: 100%; }
        #simulator-container .btn-primary-gray.active { background-color: #004481; color: white; }
        #simulator-container .confirmation-main { padding: 20px; }
        #simulator-container .confirmation-summary { text-align: center; background-color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;}
        #simulator-container .confirmation-summary h2 { font-size: 32px; font-weight: bold; color: #004481; }
        #simulator-container .confirmation-details { background-color: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        #simulator-container .detail-row { display: flex; justify-content: space-between; padding: 10px; }
        #simulator-container .authorization-section .btn { width: 100%; margin-bottom: 10px; border: 1px solid #004481; }
        #simulator-container .btn-primary-alt { background-color: #004481; color: white; }
        #simulator-container .btn-secondary-alt { background-color: white; color: #004481; }
        #simulator-container .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: flex-end; z-index: 20; opacity: 0; transition: opacity .3s ease; pointer-events: none;}
        #simulator-container .modal-overlay.active { opacity: 1; pointer-events: auto; }
        #simulator-container .be-pass-modal { background-color: white; width: 100%; border-top-left-radius: 20px; border-top-right-radius: 20px; transform: translateY(100%); transition: transform .3s ease-out; }
        #simulator-container .modal-overlay.active .be-pass-modal { transform: translateY(0); }
        #simulator-container .be-pass-icon svg { fill: #004481; }
        #simulator-container .receipt-header { background-color: #17a63a; color: white; text-align: center; padding: 30px 20px; }
        #simulator-container .success-icon { width: 50px; height: 50px; border: 2px solid white; border-radius: 50%; margin: 0 auto 15px; display: flex; justify-content: center; align-items: center; }
        #simulator-container .success-icon svg { width: 30px; height: 30px; fill: white; }
        #simulator-container .receipt-main { background-color: white; padding: 20px; flex-grow: 1; }
        #simulator-container .receipt-footer { background-color: white; }
    </style>
</head>
<body class="bg-gray-50 maia-body">

    <div id="maia-app-container" class="main-container">
        <!-- Cabecera común de MAIA -->
        <header id="app-header" class="p-6 border-b bg-white hidden">
             <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a15.045 15.045 0 01-7.5 0C4.508 19.64 2.25 15.223 2.25 10.5c0-1.25.223-2.454.634-3.582M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                    <h1 class="text-2xl font-bold tracking-tighter text-gray-800">MAIA</h1>
                </div>
                <button id="back-button" class="hidden text-gray-600 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    <span class="sr-only">Volver</span>
                </button>
            </div>
            <p class="text-gray-500 text-sm mt-1">Modelo de Aprendizaje e Inclusión Autónoma</p>
        </header>

        <main class="flex-grow flex flex-col">
            <!-- PANTALLAS DE MAIA -->
            <section id="screen-start" class="flex flex-col flex-grow items-center justify-center p-8">
                 <div class="text-center mb-12">
                    <div class="flex items-center justify-center space-x-3">
                        <svg class="w-12 h-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a15.045 15.045 0 01-7.5 0C4.508 19.64 2.25 15.223 2.25 10.5c0-1.25.223-2.454.634-3.582M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        <h1 class="text-7xl font-extrabold tracking-tighter text-gray-800">MAIA</h1>
                    </div>
                    <p class="text-gray-500 text-xl mt-2">Modelo de Aprendizaje e Inclusión Autónoma</p>
                </div>
                <button onclick="navigateTo('screen-categories')" class="big-button bg-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Comenzar</button>
            </section>
            
            <section id="screen-categories" class="flex-grow flex flex-col p-8 hidden">
                 <h2 class="text-5xl font-bold text-gray-800 mb-10 text-center">¿Sobre qué te gustaría aprender hoy?</h2>
                <div class="space-y-6">
                    <button onclick="navigateTo('screen-money')" class="big-button bg-orange-500">Dinero</button>
                    <button class="big-button bg-green-500 opacity-50 cursor-not-allowed">Salud</button>
                    <button class="big-button bg-blue-500 opacity-50 cursor-not-allowed">Redes sociales</button>
                </div>
            </section>
            
            <section id="screen-money" class="flex-grow flex flex-col p-8 bg-orange-500 hidden">
                 <h2 class="text-6xl font-bold text-white mb-10">Dinero</h2>
                <div class="space-y-6">
                    <button onclick="navigateTo('screen-simulator-intro')" class="big-button bg-white text-gray-800 !text-4xl !py-10">Transferencias bancarias</button>
                    <button class="big-button bg-white text-gray-800 !text-4xl !py-10 opacity-50 cursor-not-allowed">Pago de cuentas</button>
                    <button class="big-button bg-white text-gray-800 !text-4xl !py-10 opacity-50 cursor-not-allowed">Consultar tu saldo</button>
                </div>
            </section>

            <section id="screen-simulator-intro" class="flex flex-col flex-grow items-center justify-center p-8 text-center hidden">
                  <h2 class="text-5xl font-bold text-gray-800 mb-6">¡Vamos a practicar!</h2>
                 <p class="text-2xl text-gray-600 mb-12 max-w-2xl">A continuación, usarás un simulador para aprender a hacer una transferencia. <strong class="text-green-600">No te preocupes, es solo una práctica y no usarás dinero real.</strong></p>
                 <button onclick="navigateTo('screen-simulator')" class="big-button bg-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Empezar Práctica</button>
            </section>

            <section id="screen-simulator" class="flex-grow flex-col hidden">
                 <div class="simulator-wrapper">
                    <div id="simulator-container">
                        <!-- El JS del simulador poblará esto -->
                    </div>
                </div>
            </section>

            <section id="screen-continue-to-real" class="flex flex-col flex-grow items-center justify-center p-8 text-center hidden">
                  <h2 class="text-5xl font-bold text-gray-800 mb-6">¡Excelente práctica!</h2>
                 <p class="text-2xl text-gray-600 mb-12 max-w-2xl">Ahora que ya sabes cómo funciona, ¿te animas a hacer una transferencia real en tu propio celular?</p>
                 <div class="w-full max-w-md space-y-6">
                    <button onclick="navigateTo('screen-tutorial')" class="big-button bg-green-500">¡Sí, vamos!</button>
                    <button onclick="navigateTo('screen-start')" class="text-xl text-gray-600 hover:text-gray-900 font-bold py-4 px-6 rounded-lg">No, terminar por ahora</button>
                 </div>
            </section>

            <!-- PANTALLA 6: Tutorial con videos -->
            <section id="screen-tutorial" class="flex-grow flex flex-col hidden bg-gray-100">
                <div class="p-8">
                    <p class="text-2xl text-gray-500">Guía para transferencia real</p>
                    <div class="flex items-center gap-4">
                        <h2 id="tutorial-step-title" class="text-5xl font-bold text-gray-800 mt-2"></h2>
                    </div>
                </div>
                <div id="video-container" class="w-full flex-grow bg-black flex items-center justify-center p-4">
                    <!-- YouTube iframe se insertará aquí -->
                </div>
                <!-- Controles de navegación -->
                <div class="bg-gray-800 p-4 flex items-center justify-center space-x-2 sm:space-x-4">
                    <button id="tutorial-prev" class="text-white bg-gray-700 rounded-full p-4 hover:bg-gray-600 disabled:opacity-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                    <button id="help-button-tutorial" class="text-white bg-blue-600 rounded-full p-4 hover:bg-blue-700 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                    <button id="tutorial-next" class="text-white bg-gray-700 rounded-full p-4 hover:bg-gray-600 disabled:opacity-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></button>
                </div>
            </section>
        </main>
        
        <!-- Modal de Ayuda (MODIFICADO PARA VOZ) -->
        <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
            <div id="help-modal-content" class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-2xl w-full">
                <div class="flex justify-between items-start">
                    <h3 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">✨ ¿Necesitas ayuda?</h3>
                    <button id="close-help-modal" class="text-gray-400 hover:text-gray-800"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                
                <p id="listen-status" class="text-lg text-gray-600 mb-6 text-center">Presiona el micrófono y haz tu pregunta. Por ejemplo: "¿Qué es un destinatario?"</p>
                
                <div class="flex justify-center mb-6">
                    <button id="listen-button" class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-white transition-colors hover:bg-blue-700">
                        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93V17h-1v-2.07A5 5 0 015 10v-1h1v1a4 4 0 008 0v-1h1v1a5 5 0 01-4 4.93z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                
                <div id="answer-container" class="mt-8 hidden">
                    <h4 class="text-2xl font-bold text-gray-800 mb-2">Respuesta de MAIA:</h4>
                    <div class="bg-blue-50 p-6 rounded-lg text-xl text-gray-800 prose max-w-none"><p id="answer-text"></p></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- LÓGICA GENERAL DE MAIA ---
        const maiaScreens = document.querySelectorAll('#maia-app-container > main > section');
        const header = document.getElementById('app-header');
        const backButton = document.getElementById('back-button');
        let navigationHistory = ['screen-start'];

        function navigateTo(screenId) {
            window.speechSynthesis.cancel(); 
            maiaScreens.forEach(s => s.classList.add('hidden'));
            const nextScreen = document.getElementById(screenId);
            if (nextScreen) {
                nextScreen.classList.remove('hidden');
            } else {
                console.error(`Screen with ID ${screenId} not found!`); // Debug line
                document.getElementById('screen-start').classList.remove('hidden'); // Fallback
                screenId = 'screen-start'; // Reset screenId
            }
            
            if (screenId !== 'screen-start') {
                header.classList.remove('hidden');
                backButton.classList.remove('hidden');
                if (navigationHistory[navigationHistory.length - 1] !== screenId) {
                    navigationHistory.push(screenId);
                }
            } else {
                header.classList.add('hidden');
                navigationHistory = ['screen-start'];
            }

            switch(screenId) {
                case 'screen-categories':
                    hablar("Hola. ¿Sobre qué te gustaría aprender hoy? Toca una de las opciones.");
                    break;
                case 'screen-simulator-intro':
                    hablar("¡Vamos a practicar! No te preocupes, esto es un juego y no usarás dinero real.");
                    break;
                case 'screen-continue-to-real':
                    hablar("¡Excelente práctica! Ahora que ya sabes cómo funciona, ¿te animas a hacer una transferencia real en tu propio celular?");
                    break;
            }

            if (screenId === 'screen-simulator') {
                startSimulator(); 
            }
            if (screenId === 'screen-tutorial') {
                loadStep(0); 
            }
        }
        
        if (backButton) { // Ensure backButton exists before adding listener
            backButton.addEventListener('click', () => {
               window.speechSynthesis.cancel(); 
                if (navigationHistory.length > 1) {
                    const currentScreenId = document.querySelector('#maia-app-container > main > section:not(.hidden)')?.id;
                    navigationHistory.pop(); // Remove current screen from history
                    const previousScreenId = navigationHistory[navigationHistory.length - 1]; // Get the actual previous screen

                    // Define screens that should go back to 'screen-money'
                    const simulatorRelatedScreens = ['screen-simulator', 'screen-tutorial', 'screen-simulator-intro', 'screen-continue-to-real'];

                    if (simulatorRelatedScreens.includes(currentScreenId)) {
                         // If coming from simulator flow, decide where to go back
                         if (previousScreenId && !simulatorRelatedScreens.includes(previousScreenId)) {
                             navigateTo(previousScreenId);
                         } else {
                             navigateTo('screen-money'); // Default back target from simulator flow
                         }
                    } else {
                         navigateTo(previousScreenId || 'screen-start'); // Go to actual previous or fallback to start
                    }
                }
            });
        }


        // --- LÓGICA DEL TUTORIAL CON VIDEOS ---
        const tutorialSteps = [
             { title: "PASO 1: Abrir app de tu banco", videoSrc: "https://www.youtube.com/embed/9rn5gUPhhIw" },
            { title: "Paso 2: Ingresar a la app de banco estado con clave de seguridad", videoSrc: "https://www.youtube.com/embed/ry_wfvpwk6s" },
            { title: "Paso 3: Encontrar botón para hacer Trasnferencias", videoSrc: "https://www.youtube.com/embed/W4F-SQ-18G8" },
            { title: "Paso 4: Seleccionar usuario para hacer transferencia.", videoSrc: "https://www.youtube.com/embed/TC6udYDNrHY" },
            { title: "Paso 5: Ingresa el monto deseado", videoSrc: "https://www.youtube.com/embed/EkWl76y2u64" },
            { title: "Paso 6: Autoriza con clave bePass", videoSrc: "https://www.youtube.com/embed/EkWl76y2u64" }, // Video reutilizado
            { title: "Paso 7: Transferencia realizada.", videoSrc: "https://www.youtube.com/embed/wSNNEJAwTDM" }
        ];

        let currentStepIndex = 0;
        const stepTitleElement = document.getElementById('tutorial-step-title');
        const tutorialPrevButton = document.getElementById('tutorial-prev');
        const tutorialNextButton = document.getElementById('tutorial-next');
        const videoContainer = document.getElementById('video-container');

        function loadStep(index) {
            currentStepIndex = index;
            const step = tutorialSteps[index];
            if (!step) { // Added check for safety
                console.error(`Tutorial step at index ${index} not found.`);
                return;
            }
            if (stepTitleElement) stepTitleElement.textContent = step.title; 

            if (videoContainer) { 
                videoContainer.innerHTML = ''; 
                const iframe = document.createElement('iframe');
                iframe.setAttribute('src', `${step.videoSrc}?autoplay=1&rel=0&modestbranding=1&playsinline=1`);
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                iframe.setAttribute('allowfullscreen', '');
                iframe.className = 'w-full h-full aspect-video';
                videoContainer.appendChild(iframe);
            }

            if (tutorialPrevButton) tutorialPrevButton.disabled = index === 0; 
            if (tutorialNextButton) tutorialNextButton.disabled = index === tutorialSteps.length - 1; 
        }

        if (tutorialNextButton) tutorialNextButton.addEventListener('click', () => {
             if (currentStepIndex < tutorialSteps.length - 1) {
                 loadStep(currentStepIndex + 1)
             }
        });
        if (tutorialPrevButton) tutorialPrevButton.addEventListener('click', () => {
            if (currentStepIndex > 0) {
                 loadStep(currentStepIndex - 1)
            }
        });

        
        // --- LÓGICA DEL ASISTENTE DE VOZ (MAIA) ---
        function hablar(texto) {
            // Basic check for browser support
            if (!('speechSynthesis' in window)) {
                console.warn("Speech Synthesis not supported in this browser.");
                return;
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'es-ES'; 
            utterance.rate = 0.9; 
            window.speechSynthesis.speak(utterance);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        const listenButton = document.getElementById('listen-button'); // Moved declaration higher
        const listenStatus = document.getElementById('listen-status'); // Moved declaration higher

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = false; 
            recognition.interimResults = false;

            if (listenButton) { 
                listenButton.addEventListener('click', () => {
                   try {
                     if (recognition) recognition.start();
                     listenButton.disabled = true; // Disable button while listening/processing
                   } catch (e) {
                      console.error("Error starting recognition:", e);
                      if(listenStatus) listenStatus.textContent = "Error al iniciar escucha. ¿Permitiste el micrófono?";
                      if(listenButton) listenButton.disabled = false; // Re-enable on error
                   }
                });
            } else {
                 console.error("Listen button not found!");
            }

            recognition.onstart = () => {
                if (listenStatus) listenStatus.textContent = "Te estoy escuchando...";
                if (listenButton) listenButton.classList.add('listening'); 
            };

            recognition.onspeechend = () => {
               if(recognition) recognition.stop(); 
                 if (listenStatus) listenStatus.textContent = "MAIA está pensando..."; // Changed status message
                // Button re-enabled in onresult or onerror
            };
            
            // Added onend for robustness
             recognition.onend = () => {
                 // Check if it ended unexpectedly while it should be listening or processing
                 if (listenButton && (listenButton.classList.contains('listening') || listenStatus.textContent === "MAIA está pensando...") ) {
                     listenButton.classList.remove('listening');
                     if (listenStatus) listenStatus.textContent = "Se detuvo. Presiona el micrófono de nuevo.";
                     listenButton.disabled = false; // Re-enable button
                 }
             };

            recognition.onresult = async (event) => { // Make async
                const pregunta = event.results[0][0].transcript.toLowerCase();
                 if (listenStatus) listenStatus.textContent = `Dijiste: "${pregunta}"`;
                 if (listenButton) listenButton.classList.remove('listening'); // Stop red color

                try {
                     // Call the REAL Gemini function
                    const respuesta = await askRealGemini(pregunta); 
                    
                    const answerContainer = document.getElementById('answer-container');
                    const answerText = document.getElementById('answer-text');
                    if (answerText) answerText.textContent = respuesta;
                    if (answerContainer) answerContainer.classList.remove('hidden');
                    hablar(respuesta);
                } catch (error) {
                     console.error("Error getting Gemini response:", error);
                     if (listenStatus) listenStatus.textContent = "Hubo un problema al obtener la respuesta. Intenta de nuevo.";
                     hablar("Lo siento, hubo un problema al conectarme. Intenta de nuevo más tarde.");
                } finally {
                    // Re-enable button AFTER getting response or error
                    if(listenButton) listenButton.disabled = false;
                    if (listenStatus && listenStatus.textContent === "MAIA está pensando...") { // Reset status if still thinking
                        listenStatus.textContent = "Presiona el micrófono para hablar...";
                    }
                }
            };


            recognition.onerror = (event) => {
                 console.error("Speech recognition error:", event.error); 
                 let errorMsg = "No pude entenderte. Intenta de nuevo.";
                 if (event.error === 'no-speech') {
                    errorMsg = "No detecté que hablaras. Intenta de nuevo.";
                 } else if (event.error === 'audio-capture') {
                     errorMsg = "Problema con el micrófono. ¿Está conectado y permitido?";
                 } else if (event.error === 'not-allowed') {
                    errorMsg = "Necesito permiso para usar el micrófono.";
                 }
                 if (listenStatus) listenStatus.textContent = errorMsg;
                if (listenButton) {
                    listenButton.classList.remove('listening');
                    listenButton.disabled = false; // Re-enable button on error
                }
            };

        } else {
             if (listenStatus) listenStatus.textContent = "Lo siento, tu navegador no soporta reconocimiento de voz.";
            if (listenButton) listenButton.disabled = true;
        }

        // --- ¡NUEVO! Función para llamar a Gemini ---
        async function askRealGemini(userQuestion) {
            const apiKey = "AIzaSyAgNKRCZa_cZmcFl456RCelgDAPvF4iRLw"; // <-- ¡IMPORTANTE! Reemplaza esto con tu clave API REAL para probar
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Determinar contexto (solo basado en el tutorial por ahora)
            let context = "El usuario está aprendiendo sobre transferencias bancarias.";
            if (document.getElementById('screen-tutorial')?.classList.contains('hidden') === false && currentStepIndex >= 0 && currentStepIndex < tutorialSteps.length) {
                 context = `El usuario está en el tutorial 'Cómo hacer transferencias bancarias', específicamente en el paso: "${tutorialSteps[currentStepIndex].title}".`;
            }

            const systemPrompt = "Eres MAIA, un asistente virtual muy amigable y paciente. Tu propósito principal es ayudar a adultos mayores con baja alfabetización digital a entender conceptos de tecnología y banca. Usa siempre el lenguaje más simple posible, frases cortas, analogías claras y un tono muy tranquilizador y positivo. Evita cualquier jerga técnica. Responde siempre en español chileno informal y cercano. Anímale si parece frustrado.";

            const payload = {
                contents: [{
                    parts: [{
                        text: `${context}\n\nPregunta del usuario: "${userQuestion}"`
                    }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Safety settings can be added here if needed
                // generationConfig: { ... } 
            };

             // --- Exponential Backoff ---
            let response = null;
            let attempt = 0;
            const maxAttempts = 5;
            let delay = 1000; // Start with 1 second

            while (attempt < maxAttempts) {
                try {
                    console.log(`Calling Gemini API (Attempt ${attempt + 1})...`);
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log("Gemini Response:", result);
                         // Check for valid response structure before accessing text
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            // Handle cases where response is ok but content is missing or blocked
                            console.warn("Gemini response OK, but no text content found or content blocked.", candidate?.finishReason, candidate?.safetyRatings);
                            let fallbackMsg = "No pude generar una respuesta para eso. ¿Puedes preguntar de otra manera?";
                            if (candidate?.finishReason === 'SAFETY') {
                                fallbackMsg = "Parece que esa pregunta toca un tema delicado y no puedo responderla.";
                            }
                            return fallbackMsg;
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, retry needed
                        console.warn(`Gemini API error (Attempt ${attempt + 1}): Status ${response.status}. Retrying in ${delay / 1000}s...`);
                        // DO NOT throw error here, let the loop continue
                    } else {
                        // Other client-side error (e.g., 400 Bad Request), no retry needed
                        console.error(`Gemini API error (Attempt ${attempt + 1}): Status ${response.status}`, await response.text());
                        throw new Error(`Error ${response.status} de la API.`); // Throw specific error
                    }
                } catch (error) {
                    // Network errors or specific errors thrown above
                     console.error(`Fetch error (Attempt ${attempt + 1}):`, error);
                     if (attempt + 1 >= maxAttempts) { // Only throw on last attempt
                        throw error; // Rethrow the final error
                     }
                     // DO NOT throw error here if retrying
                }

                // If fetch failed or got a retryable status code
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; // Double the delay for next attempt
                attempt++;
            }

            // If all attempts failed
            console.error("All Gemini API attempts failed.");
            throw new Error("No se pudo conectar con el asistente después de varios intentos.");
        }


        // --- Lógica del Modal de Ayuda ---
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-modal');
        const helpButtonTutorial = document.getElementById('help-button-tutorial');
        
        if (helpButtonTutorial) {
            helpButtonTutorial.addEventListener('click', function(event) {
                event.preventDefault(); 
                event.stopPropagation(); 
                openHelp(); 
            });
        }

        function openHelp() {
            if (helpModal) { 
                helpModal.classList.remove('hidden');
                setTimeout(() => helpModal.classList.add('active'), 10);
                const answerContainer = document.getElementById('answer-container');
                const listenStatus = document.getElementById('listen-status');
                if (answerContainer) answerContainer.classList.add('hidden');
                if (listenStatus) listenStatus.textContent = "Presiona el micrófono y haz tu pregunta. Por ejemplo: \"¿Qué es un destinatario?\"";
                // Ensure listen button is enabled when opening modal
                if(listenButton) listenButton.disabled = false;
                 if(listenButton) listenButton.classList.remove('listening');

            } else {
                console.error("Help modal element not found!");
            }
        }
        
        function closeHelp() {
            window.speechSynthesis.cancel();
            if (recognition) recognition.abort();

            if (helpModal) { 
                helpModal.classList.remove('active');
                setTimeout(() => helpModal.classList.add('hidden'), 300);
            }
        }
        
       if (closeHelpButton) closeHelpButton.addEventListener('click', closeHelp);
        
        // --- INICIO: LÓGICA DEL SIMULADOR BANCOESTADO ---
        function startSimulator() {
             const SIMULATOR_HTML = `
                <div id="status-bar"><span>19:14</span></div>
                <!-- Screen 1: Phone Home Screen -->
                <div class="screen active" id="phone-home-screen"><main class="phone-home-main"><button id="banco-estado-icon" class="app-icon"><div class="app-icon-img-container"><img src="https://i.imgur.com/v8F7Qx5.png" alt="BancoEstado App Icon"><div class="notification-badge app-badge-1">170</div><div class="notification-badge app-badge-2">47</div></div><span>BancoEstado</span></button></main></div>
                <!-- Screen 2: Login -->
                <div class="screen" id="login-screen"><header class="login-header"><img src="https://i.imgur.com/rNfpE6p.png" alt="BancoEstado Logo" class="logo"></header><main class="login-main"><h1>Hola Matías</h1><button class="btn btn-primary" id="login-button">Ingresar</button><a href="#" class="link">¿Olvidaste tu clave?</a></main></div>
                <!-- Screen 3: PIN Entry -->
                <div class="screen" id="pin-screen"><header class="modal-header"><button class="close-btn" data-target="login-screen">&times;</button></header><main class="pin-main"><div class="pin-lock-icon"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg></div><h2>Ingresa tu clave</h2><div class="pin-inputs" id="login-pin-inputs"><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div></div><p id="pin-error" class="pin-error-message"></p><a href="#" class="link">¿Problemas con tu clave?</a></main><footer class="keypad-footer"><div class="keypad-actions"><button class="btn-keypad-action-primary" id="login-pin-accept">Aceptar</button></div><div class="keypad" id="login-keypad"></div></footer></div>
                <!-- Screen 4: Home/Dashboard -->
                <div class="screen" id="home-screen"><header class="home-header"><div class="home-header-wavy"></div><div class="home-header-content"><img src="https://i.imgur.com/rNfpE6p.png" alt="BancoEstado Logo" class="logo-small"></div></header><main class="home-main"><div class="card account-summary"><div class="account-details"><p><strong>CuentaRUT</strong> 00020334694</p><h3>$32</h3><p class="balance-label">Saldo disponible</p></div><div><button class="btn-secondary">Movimientos</button><button class="btn-secondary">Cartolas</button></div></div><div class="card"><p>Seguro Full Ambulatorio...</p></div></main><nav class="bottom-nav"><button class="nav-item active"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Inicio</button><button class="nav-item" id="transfer-nav-btn"><svg viewBox="0 0 24 24"><path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4v3zM8 5v3H2v2h6v3l4-4-4-4z"/></svg>Transferir</button><button class="nav-item"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>Seguridad</button><button class="nav-item"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>Más</button></nav><div class="transfer-bottom-sheet" id="transfer-sheet"><button data-target="recipient-screen">A terceros</button></div></div>
                <!-- Screen 5: Recipient Selection -->
                <div class="screen" id="recipient-screen"><header class="standard-header"><button class="back-btn" data-target="home-screen"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button><h2>Transferir</h2></header><main class="recipient-main"><div class="contact-list"><div class="contact-item" data-name="Maria Elena Maureira" data-rut="8.458.176-3" data-bank="BancoEstado" data-account-type="CuentaRUT" data-account-number="8458176"><div class="contact-avatar" style="background-color:#F06292;">MM</div><div class="contact-info"><p class="contact-name">Maria Elena Maureira</p><p class="contact-details">BancoEstado</p></div></div></div></main></div>
                <!-- Screen 6: Transfer Details -->
                <div class="screen" id="transfer-details-screen"><header class="standard-header"><button class="back-btn" data-target="recipient-screen"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button><h2>Transferir</h2></header><main class="transfer-details-main"><div class="details-section"><h3>Cuenta de origen</h3><p>CuentaRUT 00020334694</p></div><div class="details-section"><h3>Destinatario</h3><p id="dest-name"></p><p id="dest-rut"></p></div><div class="details-section"><h3>Ingresa un monto</h3><input type="text" id="transfer-amount" class="form-input" placeholder="Ej.: 5000" readonly></div></main><footer class="sticky-footer" id="transfer-details-footer"><button class="btn btn-primary-gray" id="continue-transfer-btn" disabled>Continuar</button></footer><footer class="keypad-footer" id="amount-keypad-footer" style="display: none;"><div class="keypad-actions"><button class="btn-keypad-action-primary" id="amount-keypad-done">Listo</button></div><div class="keypad" id="amount-keypad"></div></footer></div>
                <!-- Screen 7: Confirmation -->
                <div class="screen" id="confirmation-screen"><header class="standard-header"><button class="back-btn" data-target="transfer-details-screen"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button><h2>Confirma y autoriza</h2></header><main class="confirmation-main"><div class="confirmation-summary"><p id="confirm-dest-name"></p><h2 id="confirm-amount"></h2></div><div class="confirmation-details"><div class="detail-row"><p>RUT</p><p id="confirm-rut"></p></div><div class="detail-row"><p>BANCO</p><p id="confirm-bank"></p></div></div><div class="authorization-section"><h3>Autorizar transferencia con:</h3><button class="btn btn-primary-alt">BE Face</button><button id="authorize-be-pass-btn" class="btn btn-secondary-alt">BE Pass</button></div></main></div>
                <!-- Screen 8: BE Pass Modal -->
                <div class="modal-overlay" id="be-pass-modal"><div class="be-pass-modal"><header class="modal-header"><button class="close-btn" data-target="confirmation-screen">&times;</button></header><main class="pin-main"><div class="be-pass-icon pin-lock-icon"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3-8H9V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2z"/></svg></div><h2>Ingresa tu clave BE Pass</h2><div class="pin-inputs" id="be-pass-pin-inputs"><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div></div><p id="be-pass-error" class="pin-error-message"></p></main><footer class="keypad-footer"><div class="keypad-actions"><button id="be-pass-pin-accept" class="btn-keypad-action-primary">Autorizar</button></div><div class="keypad" id="be-pass-keypad"></div></footer></div></div>
                <!-- Screen 9: Receipt -->
                <div class="screen" id="receipt-screen"><header class="receipt-header"><div class="success-icon"><svg viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg></div><h2>Comprobante de Transferencia</h2></header><main class="receipt-main"><div class="detail-row"><p>Monto</p><p><strong id="receipt-amount"></strong></p></div><div class="detail-row"><p>Destinatario</p><p id="receipt-name"></p></div></main><footer class="sticky-footer receipt-footer"><button class="btn btn-secondary" id="go-home-btn">Finalizar Práctica</button></footer></div>
            `; // Note: Backticks allow multiline strings easily
            const simulatorContainer = document.getElementById('simulator-container');
            if (!simulatorContainer) {
                 console.error("Simulator container not found!");
                 return;
            }
            simulatorContainer.innerHTML = SIMULATOR_HTML; // Inject simulator HTML

            // --- Re-attach all simulator event listeners ---
            // It's crucial this runs *after* innerHTML is set
            // (All the getElementById and addEventListener logic from previous version goes here)
            // ... (rest of the simulator logic remains the same) ...
             const simScreens = simulatorContainer.querySelectorAll('.screen');
            const modalOverlays = simulatorContainer.querySelectorAll('.modal-overlay');
            let pinAttempts = { loginPin: '', bePassPin: '', amount: '', selectedRecipient: null };

            const simNavigate = (targetId, isBack = false) => {
                 const currentScreen = simulatorContainer.querySelector('.screen.active');
                const nextScreen = simulatorContainer.querySelector(`#${targetId}`);
                if (currentScreen && nextScreen && currentScreen.id !== targetId) {
                    if(isBack) {
                        currentScreen.classList.add('moving-out');
                        setTimeout(() => currentScreen.classList.remove('active', 'moving-out'), 300);
                    } else {
                       currentScreen.classList.remove('active');
                    }
                    nextScreen.classList.add('active');
                } else if (!nextScreen) {
                    console.error(`Simulator screen with ID ${targetId} not found!`);
                }
            };

            const createKeypad = (keypadId, onKeyPress) => {
                 const keypad = simulatorContainer.querySelector(`#${keypadId}`);
                if(!keypad) return;
                keypad.innerHTML = '';
                const keys = [1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, 'delete'];
                keys.forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'keypad-btn';
                    if (key === 'delete') {
                        btn.innerHTML = '&#9003;'; // Backspace symbol
                        btn.onclick = () => onKeyPress('delete');
                    } else if (key !== '') {
                        btn.textContent = key;
                        btn.onclick = () => onKeyPress(key.toString()); // Ensure key is string
                    }
                    else {
                         btn.style.visibility = 'hidden'; // Keep grid structure
                    }
                    keypad.appendChild(btn);
                });
            };


            const updatePinInputs = (pin, containerId) => {
                 const container = simulatorContainer.querySelector(`#${containerId}`);
                 if (!container) return; // Check if container exists
                const inputs = container.querySelectorAll('.pin-box');
                inputs.forEach((box, i) => {
                    box.classList.toggle('filled', i < pin.length);
                });
            };

            const handlePinInput = (key, pinVar, maxLen, inputContainerId) => {
                 let newPin = pinAttempts[pinVar] || '';
                if (key === 'delete') {
                    newPin = newPin.slice(0, -1);
                } else if (typeof key === 'string' && newPin.length < maxLen) { // Check type
                    newPin += key;
                }
                pinAttempts[pinVar] = newPin;
                updatePinInputs(newPin, inputContainerId);
            };


            const showPinError = (containerId, errorMsgId, message) => {
                 const pinContainer = simulatorContainer.querySelector(`#${containerId}`);
                const errorEl = simulatorContainer.querySelector(`#${errorMsgId}`);
                if (pinContainer) pinContainer.classList.add('shake'); // Check exists
                if (errorEl) errorEl.textContent = message; // Check exists
                setTimeout(() => {
                    if (pinContainer) pinContainer.classList.remove('shake');
                    if (errorEl) errorEl.textContent = '';
                }, 1000);
            };

            // Setup keypads only if elements exist
            createKeypad('login-keypad', (key) => handlePinInput(key, 'loginPin', 4, 'login-pin-inputs'));
            createKeypad('be-pass-keypad', (key) => handlePinInput(key, 'bePassPin', 6, 'be-pass-pin-inputs'));

            const amountInput = simulatorContainer.querySelector('#transfer-amount');
             if (amountInput) {
                createKeypad('amount-keypad', (key) => {
                    let currentAmount = pinAttempts.amount || '';
                    if (key === 'delete') {
                        currentAmount = currentAmount.slice(0, -1);
                    } else if (typeof key === 'string' && currentAmount.length < 7) {
                        currentAmount += key;
                    }
                    pinAttempts.amount = currentAmount;
                    const amountNumber = parseInt(currentAmount) || 0;
                    amountInput.value = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amountNumber);
                });
             }

            // --- Re-attach all event listeners for the simulator ---
             const bancoEstadoIcon = simulatorContainer.querySelector('#banco-estado-icon');
            if (bancoEstadoIcon) bancoEstadoIcon.addEventListener('click', () => simNavigate('login-screen'));

            const loginButton = simulatorContainer.querySelector('#login-button');
             if (loginButton) loginButton.addEventListener('click', () => simNavigate('pin-screen'));

            const loginPinAccept = simulatorContainer.querySelector('#login-pin-accept');
            if (loginPinAccept) loginPinAccept.addEventListener('click', () => {
                if (pinAttempts.loginPin === "1234") {
                    simNavigate('home-screen');
                } else {
                    showPinError('login-pin-inputs', 'pin-error', 'Clave incorrecta. Intenta con 1234.');
                }
                pinAttempts.loginPin = '';
                updatePinInputs('', 'login-pin-inputs');
            });

            const transferNavBtn = simulatorContainer.querySelector('#transfer-nav-btn');
            const transferSheet = simulatorContainer.querySelector('#transfer-sheet');
            if (transferNavBtn && transferSheet) {
                 transferNavBtn.addEventListener('click', () => {
                    transferSheet.classList.toggle('active');
                });
            }

            const transferSheetButton = simulatorContainer.querySelector('#transfer-sheet button');
            if (transferSheetButton && transferSheet) {
                transferSheetButton.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target;
                    if(target) simNavigate(target);
                    transferSheet.classList.remove('active');
                });
            }


            simulatorContainer.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    pinAttempts.selectedRecipient = item.dataset;
                    const destNameEl = simulatorContainer.querySelector('#dest-name');
                    const destRutEl = simulatorContainer.querySelector('#dest-rut');
                    if (destNameEl) destNameEl.textContent = pinAttempts.selectedRecipient.name;
                    if (destRutEl) destRutEl.textContent = pinAttempts.selectedRecipient.rut;
                    simNavigate('transfer-details-screen');
                });
            });

            const continueFooter = simulatorContainer.querySelector('#transfer-details-footer');
            const amountKeypadFooter = simulatorContainer.querySelector('#amount-keypad-footer');
            const continueBtn = simulatorContainer.querySelector('#continue-transfer-btn');

            if (amountInput && continueFooter && amountKeypadFooter) {
                amountInput.addEventListener('click', () => {
                    continueFooter.style.display = 'none';
                    amountKeypadFooter.style.display = 'block';
                });
            }

            const amountKeypadDone = simulatorContainer.querySelector('#amount-keypad-done');
             if (amountKeypadDone && continueFooter && amountKeypadFooter && continueBtn) {
                amountKeypadDone.addEventListener('click', () => {
                    continueFooter.style.display = 'block';
                    amountKeypadFooter.style.display = 'none';
                    const amount = parseInt(pinAttempts.amount || '0');
                    continueBtn.disabled = amount <= 0;
                    continueBtn.classList.toggle('active', !continueBtn.disabled);
                });
             }

            if (continueBtn) {
                continueBtn.addEventListener('click', () => {
                    if(!continueBtn.disabled && pinAttempts.selectedRecipient && amountInput) {
                        const recipient = pinAttempts.selectedRecipient;
                        const confirmDestName = simulatorContainer.querySelector('#confirm-dest-name');
                        const confirmAmount = simulatorContainer.querySelector('#confirm-amount');
                        const confirmRut = simulatorContainer.querySelector('#confirm-rut');
                        const confirmBank = simulatorContainer.querySelector('#confirm-bank');

                        if (confirmDestName) confirmDestName.textContent = recipient.name;
                        if (confirmAmount) confirmAmount.textContent = amountInput.value;
                        if (confirmRut) confirmRut.textContent = recipient.rut;
                         if (confirmBank) confirmBank.textContent = recipient.bank;

                        simNavigate('confirmation-screen');
                    }
                });
            }

            const authorizeBePassBtn = simulatorContainer.querySelector('#authorize-be-pass-btn');
            const bePassModal = simulatorContainer.querySelector('#be-pass-modal');
             if (authorizeBePassBtn && bePassModal) {
                authorizeBePassBtn.addEventListener('click', () => {
                    pinAttempts.bePassPin = '';
                    updatePinInputs('', 'be-pass-pin-inputs');
                    bePassModal.classList.add('active');
                });
            }

            const bePassPinAccept = simulatorContainer.querySelector('#be-pass-pin-accept');
            if (bePassPinAccept && amountInput && bePassModal) {
                bePassPinAccept.addEventListener('click', () => {
                    if (pinAttempts.bePassPin === "654321" && pinAttempts.selectedRecipient) {
                        const receiptAmount = simulatorContainer.querySelector('#receipt-amount');
                        const receiptName = simulatorContainer.querySelector('#receipt-name');
                        if (receiptAmount) receiptAmount.textContent = amountInput.value;
                        if (receiptName) receiptName.textContent = pinAttempts.selectedRecipient.name;
                        simNavigate('receipt-screen');
                        bePassModal.classList.remove('active');
                    } else {
                        showPinError('be-pass-pin-inputs', 'be-pass-error', 'Clave incorrecta. Intenta con 654321.');
                        pinAttempts.bePassPin = '';
                        updatePinInputs('', 'be-pass-pin-inputs');
                    }
                });
            }


            simulatorContainer.querySelectorAll('.back-btn, .close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target;
                    if (target) simNavigate(target, true);
                    const modal = e.currentTarget.closest('.modal-overlay');
                    if (modal) modal.classList.remove('active');
                });
            });

            const goHomeBtn = simulatorContainer.querySelector('#go-home-btn');
            if (goHomeBtn) goHomeBtn.addEventListener('click', () => {
                navigateTo('screen-continue-to-real');
            });
        }
        // --- FIN DE LA LÓGICA DEL SIMULADOR ---

        // Initialize the first screen on load
        document.addEventListener('DOMContentLoaded', () => {
             if (document.getElementById('screen-start')) {
                navigateTo('screen-start');
             } else {
                console.error("MAIA core screen 'screen-start' not found. Initialization failed.");
             }
        });

    </script>
</body>
</html>
